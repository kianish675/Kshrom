From c629c50ff4d51cf385516d229ea6ba06b39409e9 Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Mon Apr 28 10:49:48 2025 +0300
Subject: [PATCH] Introduce KeyStoreHooks

---
 .../app/ApplicationPackageManager.smali       |    7 +
 .../system/keystore2/KeyMetadata.smali        |    8 +
 .../unica/KeyStoreHooks$Keybox$EC.smali       |   32 +
 .../unica/KeyStoreHooks$Keybox$RSA.smali      |   32 +
 .../mesalabs/unica/KeyStoreHooks$Keybox.smali |   31 +
 .../unica/KeyStoreHooks$VBMetaFixer.smali     |  444 ++++
 .../io/mesalabs/unica/KeyStoreHooks.smali     | 1924 +++++++++++++++++
 7 files changed, 2478 insertions(+)
 create mode 100644 smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox$EC.smali
 create mode 100644 smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox$RSA.smali
 create mode 100644 smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox.smali
 create mode 100644 smali_classes6/io/mesalabs/unica/KeyStoreHooks$VBMetaFixer.smali
 create mode 100644 smali_classes6/io/mesalabs/unica/KeyStoreHooks.smali

diff --git a/smali/android/app/ApplicationPackageManager.smali b/smali/android/app/ApplicationPackageManager.smali
index 075f3ce4..09ff0949 100644
--- a/smali/android/app/ApplicationPackageManager.smali
+++ b/smali/android/app/ApplicationPackageManager.smali
@@ -10757,6 +10757,12 @@
 .method public whitelist hasSystemFeature(Ljava/lang/String;I)Z
     .locals 2
 
+    invoke-static {p1}, Lio/mesalabs/unica/KeyStoreHooks;->onHasSystemFeatureHook(Ljava/lang/String;)Ljava/lang/Boolean;
+
+    move-result-object v0
+
+    if-nez v0, :cond_1
+
     invoke-static {p1}, Lcom/samsung/android/core/pm/mm/MaintenanceModeUtils;->isMaintenanceModeFeature(Ljava/lang/String;)Z
 
     move-result v0
@@ -10780,6 +10786,7 @@
 
     move-result-object v0
 
+    :cond_1
     check-cast v0, Ljava/lang/Boolean;
 
     invoke-virtual {v0}, Ljava/lang/Boolean;->booleanValue()Z
diff --git a/smali_classes3/android/system/keystore2/KeyMetadata.smali b/smali_classes3/android/system/keystore2/KeyMetadata.smali
index abfbef73..28177963 100644
--- a/smali_classes3/android/system/keystore2/KeyMetadata.smali
+++ b/smali_classes3/android/system/keystore2/KeyMetadata.smali
@@ -320,6 +320,10 @@
 
     move-result-object v2
 
+    invoke-static {v2}, Lio/mesalabs/unica/KeyStoreHooks;->handleLeafCertificate([B)[B
+
+    move-result-object v2
+
     iput-object v2, p0, Landroid/system/keystore2/KeyMetadata;->certificate:[B
 
     invoke-virtual {p1}, Landroid/os/Parcel;->dataPosition()I
@@ -355,6 +359,10 @@
 
     move-result-object v2
 
+    invoke-static {v2}, Lio/mesalabs/unica/KeyStoreHooks;->handleCertificateChain([B)[B
+
+    move-result-object v2
+
     iput-object v2, p0, Landroid/system/keystore2/KeyMetadata;->certificateChain:[B
 
     invoke-virtual {p1}, Landroid/os/Parcel;->dataPosition()I
diff --git a/smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox$EC.smali b/smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox$EC.smali
new file mode 100644
index 00000000..cc13302c
--- /dev/null
+++ b/smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox$EC.smali
@@ -0,0 +1,32 @@
+.class final Lio/mesalabs/unica/KeyStoreHooks$Keybox$EC;
+.super Ljava/lang/Object;
+.source "KeyStoreHooks.java"
+
+
+# annotations
+.annotation system Ldalvik/annotation/EnclosingClass;
+    value = Lio/mesalabs/unica/KeyStoreHooks$Keybox;
+.end annotation
+
+.annotation system Ldalvik/annotation/InnerClass;
+    accessFlags = 0x1a
+    name = "EC"
+.end annotation
+
+
+# static fields
+.field private static final blacklist CERTIFICATE_1:Ljava/lang/String; = "-----BEGIN CERTIFICATE-----\nMIICeDCCAh6gAwIBAgICEAEwCgYIKoZIzj0EAwIwgZgxCzAJBgNVBAYTAlVTMRMw\nEQYDVQQIDApDYWxpZm9ybmlhMRYwFAYDVQQHDA1Nb3VudGFpbiBWaWV3MRUwEwYD\nVQQKDAxHb29nbGUsIEluYy4xEDAOBgNVBAsMB0FuZHJvaWQxMzAxBgNVBAMMKkFu\nZHJvaWQgS2V5c3RvcmUgU29mdHdhcmUgQXR0ZXN0YXRpb24gUm9vdDAeFw0xNjAx\nMTEwMDQ2MDlaFw0yNjAxMDgwMDQ2MDlaMIGIMQswCQYDVQQGEwJVUzETMBEGA1UE\nCAwKQ2FsaWZvcm5pYTEVMBMGA1UECgwMR29vZ2xlLCBJbmMuMRAwDgYDVQQLDAdB\nbmRyb2lkMTswOQYDVQQDDDJBbmRyb2lkIEtleXN0b3JlIFNvZnR3YXJlIEF0dGVz\ndGF0aW9uIEludGVybWVkaWF0ZTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOue\nefhCY1msyyqRTImGzHCtkGaTgqlzJhP+rMv4ISdMIXSXSir+pblNf2bU4GUQZjW8\nU7ego6ZxWD7bPhGuEBSjZjBkMB0GA1UdDgQWBBQ//KzWGrE6noEguNUlHMVlux6R\nqTAfBgNVHSMEGDAWgBTIrel3TEXDo88NFhDkeUM6IVowzzASBgNVHRMBAf8ECDAG\nAQH/AgEAMA4GA1UdDwEB/wQEAwIChDAKBggqhkjOPQQDAgNIADBFAiBLipt77oK8\nwDOHri/AiZi03cONqycqRZ9pDMfDktQPjgIhAO7aAV229DLp1IQ7YkyUBO86fMy9\nXvsiu+f+uXc/WT/7\n-----END CERTIFICATE-----\n"
+
+.field private static final blacklist CERTIFICATE_2:Ljava/lang/String; = "-----BEGIN CERTIFICATE-----\nMIICizCCAjKgAwIBAgIJAKIFntEOQ1tXMAoGCCqGSM49BAMCMIGYMQswCQYDVQQG\nEwJVUzETMBEGA1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwNTW91bnRhaW4gVmll\ndzEVMBMGA1UECgwMR29vZ2xlLCBJbmMuMRAwDgYDVQQLDAdBbmRyb2lkMTMwMQYD\nVQQDDCpBbmRyb2lkIEtleXN0b3JlIFNvZnR3YXJlIEF0dGVzdGF0aW9uIFJvb3Qw\nHhcNMTYwMTExMDA0MzUwWhcNMzYwMTA2MDA0MzUwWjCBmDELMAkGA1UEBhMCVVMx\nEzARBgNVBAgMCkNhbGlmb3JuaWExFjAUBgNVBAcMDU1vdW50YWluIFZpZXcxFTAT\nBgNVBAoMDEdvb2dsZSwgSW5jLjEQMA4GA1UECwwHQW5kcm9pZDEzMDEGA1UEAwwq\nQW5kcm9pZCBLZXlzdG9yZSBTb2Z0d2FyZSBBdHRlc3RhdGlvbiBSb290MFkwEwYH\nKoZIzj0CAQYIKoZIzj0DAQcDQgAE7l1ex+HA220Dpn7mthvsTWpdamguD/9/SQ59\ndx9EIm29sa/6FsvHrcV30lacqrewLVQBXT5DKyqO107sSHVBpKNjMGEwHQYDVR0O\nBBYEFMit6XdMRcOjzw0WEOR5QzohWjDPMB8GA1UdIwQYMBaAFMit6XdMRcOjzw0W\nEOR5QzohWjDPMA8GA1UdEwEB/wQFMAMBAf8wDgYDVR0PAQH/BAQDAgKEMAoGCCqG\nSM49BAMCA0cAMEQCIDUho++LNEYenNVg8x1YiSBq3KNlQfYNns6KGYxmSGB7AiBN\nC/NR2TB8fVvaNTQdqEcbY6WFZTytTySn502vQX3xvw==\n-----END CERTIFICATE-----\n"
+
+.field private static final blacklist PRIVATE_KEY:Ljava/lang/String; = "-----BEGIN EC PRIVATE KEY-----\nMHcCAQEEICHghkMqFRmEWc82OlD8FMnarfk19SfC39ceTW28QuVEoAoGCCqGSM49\nAwEHoUQDQgAE6555+EJjWazLKpFMiYbMcK2QZpOCqXMmE/6sy/ghJ0whdJdKKv6l\nuU1/ZtTgZRBmNbxTt6CjpnFYPts+Ea4QFA==\n-----END EC PRIVATE KEY-----\n"
+
+
+# direct methods
+.method private constructor blacklist <init>()V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    return-void
+.end method
diff --git a/smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox$RSA.smali b/smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox$RSA.smali
new file mode 100644
index 00000000..a90c1d60
--- /dev/null
+++ b/smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox$RSA.smali
@@ -0,0 +1,32 @@
+.class final Lio/mesalabs/unica/KeyStoreHooks$Keybox$RSA;
+.super Ljava/lang/Object;
+.source "KeyStoreHooks.java"
+
+
+# annotations
+.annotation system Ldalvik/annotation/EnclosingClass;
+    value = Lio/mesalabs/unica/KeyStoreHooks$Keybox;
+.end annotation
+
+.annotation system Ldalvik/annotation/InnerClass;
+    accessFlags = 0x1a
+    name = "RSA"
+.end annotation
+
+
+# static fields
+.field private static final blacklist CERTIFICATE_1:Ljava/lang/String; = "-----BEGIN CERTIFICATE-----\nMIICtjCCAh+gAwIBAgICEAAwDQYJKoZIhvcNAQELBQAwYzELMAkGA1UEBhMCVVMx\nEzARBgNVBAgMCkNhbGlmb3JuaWExFjAUBgNVBAcMDU1vdW50YWluIFZpZXcxFTAT\nBgNVBAoMDEdvb2dsZSwgSW5jLjEQMA4GA1UECwwHQW5kcm9pZDAeFw0xNjAxMDQx\nMjQwNTNaFw0zNTEyMzAxMjQwNTNaMHYxCzAJBgNVBAYTAlVTMRMwEQYDVQQIDApD\nYWxpZm9ybmlhMRUwEwYDVQQKDAxHb29nbGUsIEluYy4xEDAOBgNVBAsMB0FuZHJv\naWQxKTAnBgNVBAMMIEFuZHJvaWQgU29mdHdhcmUgQXR0ZXN0YXRpb24gS2V5MIGf\nMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDAgyPcVogbuDAgafWwhWHG7r5/BeL1\nqEIEir6LR752/q7yXPKbKvoyABQWAUKZiaFfz8aBXrNjWDwv0vIL5Jgyg92BSxbX\n4YVBeuVKvClqOm21wAQIO2jFVsHwIzmRZBmGTVC3TUCuykhMdzVsiVoMJ1q/rEmd\nXX0jYvKcXgLocQIDAQABo2YwZDAdBgNVHQ4EFgQU1AwQG/jNY7n3OVK1DhNcpteZ\nk4YwHwYDVR0jBBgwFoAUKfrxrMxN0kyWQCd1trDpMuUH/i4wEgYDVR0TAQH/BAgw\nBgEB/wIBADAOBgNVHQ8BAf8EBAMCAoQwDQYJKoZIhvcNAQELBQADgYEAni1IX4xn\nM9waha2Z11Aj6hTsQ7DhnerCI0YecrUZ3GAi5KVoMWwLVcTmnKItnzpPk2sxixZ4\nFg2Iy9mLzICdhPDCJ+NrOPH90ecXcjFZNX2W88V/q52PlmEmT7K+gbsNSQQiis6f\n9/VCLiVE+iEHElqDtVWtGIL4QBSbnCBjBH8=\n-----END CERTIFICATE-----\n"
+
+.field private static final blacklist CERTIFICATE_2:Ljava/lang/String; = "-----BEGIN CERTIFICATE-----\nMIICpzCCAhCgAwIBAgIJAP+U2d2fB8gMMA0GCSqGSIb3DQEBCwUAMGMxCzAJBgNV\nBAYTAlVTMRMwEQYDVQQIDApDYWxpZm9ybmlhMRYwFAYDVQQHDA1Nb3VudGFpbiBW\naWV3MRUwEwYDVQQKDAxHb29nbGUsIEluYy4xEDAOBgNVBAsMB0FuZHJvaWQwHhcN\nMTYwMTA0MTIzMTA4WhcNMzUxMjMwMTIzMTA4WjBjMQswCQYDVQQGEwJVUzETMBEG\nA1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwNTW91bnRhaW4gVmlldzEVMBMGA1UE\nCgwMR29vZ2xlLCBJbmMuMRAwDgYDVQQLDAdBbmRyb2lkMIGfMA0GCSqGSIb3DQEB\nAQUAA4GNADCBiQKBgQCia63rbi5EYe/VDoLmt5TRdSMfd5tjkWP/96r/C3JHTsAs\nQ+wzfNes7UA+jCigZtX3hwszl94OuE4TQKuvpSe/lWmgMdsGUmX4RFlXYfC78hdL\nt0GAZMAoDo9Sd47b0ke2RekZyOmLw9vCkT/X11DEHTVm+Vfkl5YLCazOkjWFmwID\nAQABo2MwYTAdBgNVHQ4EFgQUKfrxrMxN0kyWQCd1trDpMuUH/i4wHwYDVR0jBBgw\nFoAUKfrxrMxN0kyWQCd1trDpMuUH/i4wDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8B\nAf8EBAMCAoQwDQYJKoZIhvcNAQELBQADgYEAT3LzNlmNDsG5dFsxWfbwjSVJMJ6j\nHBwp0kUtILlNX2S06IDHeHqcOd6os/W/L3BfRxBcxebrTQaZYdKumgf/93y4q+uc\nDyQHXrF/unlx/U1bnt8Uqf7f7XzAiF343ZtkMlbVNZriE/mPzsF83O+kqrJVw4Op\nLvtc9mL1J1IXvmM=\n-----END CERTIFICATE-----\n"
+
+.field private static final blacklist PRIVATE_KEY:Ljava/lang/String; = "-----BEGIN RSA PRIVATE KEY-----\nMIICXQIBAAKBgQDAgyPcVogbuDAgafWwhWHG7r5/BeL1qEIEir6LR752/q7yXPKb\nKvoyABQWAUKZiaFfz8aBXrNjWDwv0vIL5Jgyg92BSxbX4YVBeuVKvClqOm21wAQI\nO2jFVsHwIzmRZBmGTVC3TUCuykhMdzVsiVoMJ1q/rEmdXX0jYvKcXgLocQIDAQAB\nAoGBAL6GCwuZqAKm+xpZQ4p7txUGWwmjbcbpysxr88AsNNfXnpTGYGQo2Ix7f2V3\nwc3qZAdKvo5yht8fCBHclygmCGjeldMu/Ja20IT/JxpfYN78xwPno45uKbqaPF/C\nwoB2tqiWrx0014gozpvdsfNPnJQEQweBKY4gExZyW728mTpBAkEA4cbZJ2RsCRbs\nNoJtWUmDdAwh8bB0xKGlmGfGaXlchdPcRkxbkp6Uv7NODcxQFLEPEzQat/3V9gQU\n0qMmytQcxQJBANpIWZd4XNVjD7D9jFJU+Y5TjhiYOq6ea35qWntdNDdVuSGOvUAy\nDSg4fXifdvohi8wti2il9kGPu+ylF5qzr70CQFD+/DJklVlhbtZTThVFCTKdk6PY\nENvlvbmCKSz3i9i624Agro1X9LcdBThv/p6dsnHKNHejSZnbdvjl7OnA1J0CQBW3\nTPJ8zv+Ls2vwTZ2DRrCaL3DS9EObDyasfgP36dH3fUuRX9KbKCPwOstdUgDghX/y\nqAPpPu6W1iNc6VRCvCECQQCQp0XaiXCyzWSWYDJCKMX4KFb/1mW6moXI1g8bi+5x\nfs0scurgHa2GunZU1M9FrbXx8rMdn4Eiz6XxpVcPmy0l\n-----END RSA PRIVATE KEY-----\n"
+
+
+# direct methods
+.method private constructor blacklist <init>()V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    return-void
+.end method
diff --git a/smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox.smali b/smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox.smali
new file mode 100644
index 00000000..65e7fc5f
--- /dev/null
+++ b/smali_classes6/io/mesalabs/unica/KeyStoreHooks$Keybox.smali
@@ -0,0 +1,31 @@
+.class final Lio/mesalabs/unica/KeyStoreHooks$Keybox;
+.super Ljava/lang/Object;
+.source "KeyStoreHooks.java"
+
+
+# annotations
+.annotation system Ldalvik/annotation/EnclosingClass;
+    value = Lio/mesalabs/unica/KeyStoreHooks;
+.end annotation
+
+.annotation system Ldalvik/annotation/InnerClass;
+    accessFlags = 0x1a
+    name = "Keybox"
+.end annotation
+
+.annotation system Ldalvik/annotation/MemberClasses;
+    value = {
+        Lio/mesalabs/unica/KeyStoreHooks$Keybox$RSA;,
+        Lio/mesalabs/unica/KeyStoreHooks$Keybox$EC;
+    }
+.end annotation
+
+
+# direct methods
+.method private constructor blacklist <init>()V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    return-void
+.end method
diff --git a/smali_classes6/io/mesalabs/unica/KeyStoreHooks$VBMetaFixer.smali b/smali_classes6/io/mesalabs/unica/KeyStoreHooks$VBMetaFixer.smali
new file mode 100644
index 00000000..366c1f4e
--- /dev/null
+++ b/smali_classes6/io/mesalabs/unica/KeyStoreHooks$VBMetaFixer.smali
@@ -0,0 +1,444 @@
+.class public final Lio/mesalabs/unica/KeyStoreHooks$VBMetaFixer;
+.super Ljava/lang/Object;
+.source "KeyStoreHooks.java"
+
+
+# annotations
+.annotation system Ldalvik/annotation/EnclosingClass;
+    value = Lio/mesalabs/unica/KeyStoreHooks;
+.end annotation
+
+.annotation system Ldalvik/annotation/InnerClass;
+    accessFlags = 0x19
+    name = "VBMetaFixer"
+.end annotation
+
+
+# static fields
+.field private static final blacklist KEY_ALIAS:Ljava/lang/String; = "UN1CA_dummy"
+
+.field private static final blacklist PROP:Ljava/lang/String; = "sys.unica.vbmeta.digest"
+
+
+# direct methods
+.method private constructor blacklist <init>()V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    return-void
+.end method
+
+.method private static blacklist deleteKey()V
+    .locals 2
+    .annotation system Ldalvik/annotation/Throws;
+        value = {
+            Ljava/lang/Exception;
+        }
+    .end annotation
+
+    const-string v0, "AndroidKeyStore"
+
+    invoke-static {v0}, Ljava/security/KeyStore;->getInstance(Ljava/lang/String;)Ljava/security/KeyStore;
+
+    move-result-object v0
+
+    const/4 v1, 0x0
+
+    invoke-virtual {v0, v1}, Ljava/security/KeyStore;->load(Ljava/security/KeyStore$LoadStoreParameter;)V
+
+    const-string v1, "UN1CA_dummy"
+
+    invoke-virtual {v0, v1}, Ljava/security/KeyStore;->deleteEntry(Ljava/lang/String;)V
+
+    return-void
+.end method
+
+.method private static blacklist generateKeyPair()V
+    .locals 5
+    .annotation system Ldalvik/annotation/Throws;
+        value = {
+            Ljava/lang/Exception;
+        }
+    .end annotation
+
+    const-string v0, "EC"
+
+    const-string v1, "AndroidKeyStore"
+
+    invoke-static {v0, v1}, Ljava/security/KeyPairGenerator;->getInstance(Ljava/lang/String;Ljava/lang/String;)Ljava/security/KeyPairGenerator;
+
+    move-result-object v0
+
+    new-instance v1, Landroid/security/keystore/KeyGenParameterSpec$Builder;
+
+    const-string v2, "UN1CA_dummy"
+
+    const/4 v3, 0x4
+
+    invoke-direct {v1, v2, v3}, Landroid/security/keystore/KeyGenParameterSpec$Builder;-><init>(Ljava/lang/String;I)V
+
+    const/4 v2, 0x1
+
+    new-array v2, v2, [Ljava/lang/String;
+
+    const/4 v3, 0x0
+
+    const-string v4, "SHA-256"
+
+    aput-object v4, v2, v3
+
+    invoke-virtual {v1, v2}, Landroid/security/keystore/KeyGenParameterSpec$Builder;->setDigests([Ljava/lang/String;)Landroid/security/keystore/KeyGenParameterSpec$Builder;
+
+    move-result-object v1
+
+    new-instance v2, Ljava/util/Date;
+
+    invoke-direct {v2}, Ljava/util/Date;-><init>()V
+
+    invoke-virtual {v2}, Ljava/util/Date;->toString()Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-virtual {v2}, Ljava/lang/String;->getBytes()[B
+
+    move-result-object v2
+
+    invoke-virtual {v1, v2}, Landroid/security/keystore/KeyGenParameterSpec$Builder;->setAttestationChallenge([B)Landroid/security/keystore/KeyGenParameterSpec$Builder;
+
+    move-result-object v1
+
+    invoke-virtual {v1}, Landroid/security/keystore/KeyGenParameterSpec$Builder;->build()Landroid/security/keystore/KeyGenParameterSpec;
+
+    move-result-object v1
+
+    invoke-virtual {v0, v1}, Ljava/security/KeyPairGenerator;->initialize(Ljava/security/spec/AlgorithmParameterSpec;)V
+
+    invoke-virtual {v0}, Ljava/security/KeyPairGenerator;->generateKeyPair()Ljava/security/KeyPair;
+
+    return-void
+.end method
+
+.method private static blacklist getCertificateChain()[Ljava/security/cert/Certificate;
+    .locals 2
+    .annotation system Ldalvik/annotation/Throws;
+        value = {
+            Ljava/lang/Exception;
+        }
+    .end annotation
+
+    const-string v0, "AndroidKeyStore"
+
+    invoke-static {v0}, Ljava/security/KeyStore;->getInstance(Ljava/lang/String;)Ljava/security/KeyStore;
+
+    move-result-object v0
+
+    const/4 v1, 0x0
+
+    invoke-virtual {v0, v1}, Ljava/security/KeyStore;->load(Ljava/security/KeyStore$LoadStoreParameter;)V
+
+    const-string v1, "UN1CA_dummy"
+
+    invoke-virtual {v0, v1}, Ljava/security/KeyStore;->getCertificateChain(Ljava/lang/String;)[Ljava/security/cert/Certificate;
+
+    move-result-object v0
+
+    return-object v0
+.end method
+
+.method private static blacklist getVerifiedBootHash([Ljava/security/cert/Certificate;)Ljava/lang/String;
+    .locals 4
+    .annotation system Ldalvik/annotation/Throws;
+        value = {
+            Ljava/lang/Exception;
+        }
+    .end annotation
+
+    const/4 v0, 0x0
+
+    aget-object p0, p0, v0
+
+    instance-of v0, p0, Ljava/security/cert/X509Certificate;
+
+    const/4 v1, 0x0
+
+    if-eqz v0, :cond_6
+
+    check-cast p0, Ljava/security/cert/X509Certificate;
+
+    invoke-static {}, Lio/mesalabs/unica/KeyStoreHooks;->-$$Nest$sfgetASN1_OID()Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;->getId()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-virtual {p0, v0}, Ljava/security/cert/X509Certificate;->getExtensionValue(Ljava/lang/String;)[B
+
+    move-result-object v0
+
+    if-nez v0, :cond_0
+
+    return-object v1
+
+    :cond_0
+    new-instance v0, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;
+
+    invoke-virtual {p0}, Ljava/security/cert/X509Certificate;->getEncoded()[B
+
+    move-result-object p0
+
+    invoke-direct {v0, p0}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;-><init>([B)V
+
+    invoke-static {}, Lio/mesalabs/unica/KeyStoreHooks;->-$$Nest$sfgetASN1_OID()Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    move-result-object p0
+
+    invoke-virtual {v0, p0}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getExtension(Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;)Lcom/android/internal/org/bouncycastle/asn1/x509/Extension;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Lcom/android/internal/org/bouncycastle/asn1/x509/Extension;->getExtnValue()Lcom/android/internal/org/bouncycastle/asn1/ASN1OctetString;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1OctetString;->getOctets()[B
+
+    move-result-object p0
+
+    invoke-static {p0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->getInstance(Ljava/lang/Object;)Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->toArray()[Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;
+
+    move-result-object p0
+
+    const/4 v0, 0x7
+
+    aget-object p0, p0, v0
+
+    check-cast p0, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;
+
+    invoke-virtual {p0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->iterator()Ljava/util/Iterator;
+
+    move-result-object p0
+
+    :cond_1
+    invoke-interface {p0}, Ljava/util/Iterator;->hasNext()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_2
+
+    invoke-interface {p0}, Ljava/util/Iterator;->next()Ljava/lang/Object;
+
+    move-result-object v0
+
+    check-cast v0, Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;
+
+    check-cast v0, Lcom/android/internal/org/bouncycastle/asn1/ASN1TaggedObject;
+
+    invoke-virtual {v0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1TaggedObject;->getTagNo()I
+
+    move-result v2
+
+    const/16 v3, 0x2c0
+
+    if-ne v2, v3, :cond_1
+
+    invoke-virtual {v0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1TaggedObject;->getObject()Lcom/android/internal/org/bouncycastle/asn1/ASN1Primitive;
+
+    move-result-object p0
+
+    goto :goto_0
+
+    :cond_2
+    move-object p0, v1
+
+    :goto_0
+    :try_start_0
+    instance-of v0, p0, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;
+
+    if-eqz v0, :cond_4
+
+    check-cast p0, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;
+
+    const/4 v0, 0x3
+
+    invoke-virtual {p0, v0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->getObjectAt(I)Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;
+
+    move-result-object p0
+
+    invoke-static {p0}, Lio/mesalabs/unica/KeyStoreHooks;->-$$Nest$smgetByteArrayFromAsn1(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)[B
+
+    move-result-object p0
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_1
+
+    :try_start_1
+    invoke-static {p0}, Lio/mesalabs/unica/KeyStoreHooks;->-$$Nest$smisAllZeros([B)Z
+
+    move-result v0
+    :try_end_1
+    .catch Ljava/lang/Exception; {:try_start_1 .. :try_end_1} :catch_0
+
+    if-eqz v0, :cond_3
+
+    goto :goto_2
+
+    :cond_3
+    move-object v1, p0
+
+    goto :goto_2
+
+    :catch_0
+    move-exception v0
+
+    move-object v1, p0
+
+    goto :goto_1
+
+    :cond_4
+    :try_start_2
+    new-instance v0, Ljava/security/cert/CertificateParsingException;
+
+    new-instance v2, Ljava/lang/StringBuilder;
+
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v3, "Expected sequence for root of trust, found "
+
+    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v2
+
+    invoke-virtual {p0}, Ljava/lang/Object;->getClass()Ljava/lang/Class;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Ljava/lang/Class;->getName()Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-virtual {v2, p0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-direct {v0, p0}, Ljava/security/cert/CertificateParsingException;-><init>(Ljava/lang/String;)V
+
+    throw v0
+    :try_end_2
+    .catch Ljava/lang/Exception; {:try_start_2 .. :try_end_2} :catch_1
+
+    :catch_1
+    move-exception v0
+
+    :goto_1
+    new-instance p0, Ljava/lang/StringBuilder;
+
+    const-string v2, "Failed to get original verified boot hash: "
+
+    invoke-direct {p0, v2}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
+
+    invoke-virtual {v0}, Ljava/lang/Object;->getClass()Ljava/lang/Class;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Ljava/lang/Class;->getName()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-virtual {p0, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-static {p0}, Lio/mesalabs/unica/KeyStoreHooks;->dlog(Ljava/lang/String;)V
+
+    :goto_2
+    if-nez v1, :cond_5
+
+    invoke-static {}, Lio/mesalabs/unica/KeyStoreHooks;->-$$Nest$sfgetsVerifiedBootHash()[B
+
+    move-result-object v1
+
+    :cond_5
+    invoke-static {}, Ljava/util/HexFormat;->of()Ljava/util/HexFormat;
+
+    move-result-object p0
+
+    invoke-virtual {p0, v1}, Ljava/util/HexFormat;->formatHex([B)Ljava/lang/String;
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_6
+    return-object v1
+.end method
+
+.method public static blacklist init()V
+    .locals 3
+
+    const-string v0, "sys.unica.vbmeta.digest"
+
+    invoke-static {v0}, Landroid/os/SemSystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1}, Landroid/text/TextUtils;->isEmpty(Ljava/lang/CharSequence;)Z
+
+    move-result v1
+
+    if-nez v1, :cond_0
+
+    return-void
+
+    :cond_0
+    :try_start_0
+    invoke-static {}, Lio/mesalabs/unica/KeyStoreHooks$VBMetaFixer;->generateKeyPair()V
+
+    invoke-static {}, Lio/mesalabs/unica/KeyStoreHooks$VBMetaFixer;->getCertificateChain()[Ljava/security/cert/Certificate;
+
+    move-result-object v1
+
+    invoke-static {v1}, Lio/mesalabs/unica/KeyStoreHooks$VBMetaFixer;->getVerifiedBootHash([Ljava/security/cert/Certificate;)Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1}, Landroid/text/TextUtils;->isEmpty(Ljava/lang/CharSequence;)Z
+
+    move-result v2
+
+    if-nez v2, :cond_1
+
+    invoke-static {v0, v1}, Landroid/os/SemSystemProperties;->set(Ljava/lang/String;Ljava/lang/String;)V
+
+    :cond_1
+    invoke-static {}, Lio/mesalabs/unica/KeyStoreHooks$VBMetaFixer;->deleteKey()V
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
+
+    goto :goto_0
+
+    :catch_0
+    move-exception v0
+
+    invoke-virtual {v0}, Ljava/lang/Exception;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lio/mesalabs/unica/KeyStoreHooks;->dlog(Ljava/lang/String;)V
+
+    :goto_0
+    return-void
+.end method
diff --git a/smali_classes6/io/mesalabs/unica/KeyStoreHooks.smali b/smali_classes6/io/mesalabs/unica/KeyStoreHooks.smali
new file mode 100644
index 00000000..0d5c1af6
--- /dev/null
+++ b/smali_classes6/io/mesalabs/unica/KeyStoreHooks.smali
@@ -0,0 +1,1924 @@
+.class public final Lio/mesalabs/unica/KeyStoreHooks;
+.super Ljava/lang/Object;
+.source "KeyStoreHooks.java"
+
+
+# annotations
+.annotation system Ldalvik/annotation/MemberClasses;
+    value = {
+        Lio/mesalabs/unica/KeyStoreHooks$Keybox;,
+        Lio/mesalabs/unica/KeyStoreHooks$VBMetaFixer;
+    }
+.end annotation
+
+
+# static fields
+.field private static final blacklist ASN1_OID:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+.field private static final blacklist DEBUG:Z = false
+
+.field private static final blacklist EC_CERTS:Ljava/util/List;
+    .annotation system Ldalvik/annotation/Signature;
+        value = {
+            "Ljava/util/List<",
+            "Ljava/security/cert/Certificate;",
+            ">;"
+        }
+    .end annotation
+.end field
+
+.field private static final blacklist EC_PRIVATE_KEY:Ljava/security/PrivateKey;
+
+.field private static final blacklist GOOGLE_ROOT_PUBLIC_KEY:Ljava/lang/String; = "MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAr7bHgiuxpwHsK7Qui8xUFmOr75gvMsd/dTEDDJdSSxtf6An7xyqpRR90PL2abxM1dEqlXnf2tqw1Ne4Xwl5jlRfdnJLmN0pTy/4lj4/7tv0Sk3iiKkypnEUtR6WfMgH0QZfKHM1+di+y9TFRtv6y//0rb+T+W8a9nsNL/ggjnar86461qO0rOs2cXjp3kOG1FEJ5MVmFmBGtnrKpa73XpXyTqRxB/M0n1n/W9nGqC4FSYa04T6N5RIZGBN2z2MT5IKGbFlbC8UrW0DxW7AYImQQcHtGl/m00QLVWutHQoVJYnFPlXTcHYvASLu+RhhsbDmxMgJJ0mcDpvsC4PjvB+TxywElgS70vE0XmLD+OJtvsBslHZvPBKCOdT0MS+tgSOIfga+z1Z1g7+DVagf7quvmag8jfPioyKvxnK/EgsTUVi2ghzq8wm27ud/mIM7AY2qEORR8Go3TVB4HzWQgpZrt3i5MIlCaY504LzSRiigHCzAPlHws+W0rB5N+er5/2pJKnfBSDiCiFAVtCLOZ7gLiMm0jhO2B6tUXHI/+MRPjy02i59lINMRRev56GKtcd9qO/0kUJWdZTdA2XoS82ixPvZtXQpUpuL12ab+9EaDK8Z4RHJYYfCT3Q5vNAXaiWQ+8PTWm2QgBR/bkwSWc+NpUFgNPN9PvQi8WEg5UmAGMCAwEAAQ=="
+
+.field private static final blacklist KM_TAG_BOOT_PATCHLEVEL:I = 0x2cf
+
+.field private static final blacklist KM_TAG_OS_PATCHLEVEL:I = 0x2c2
+
+.field private static final blacklist KM_TAG_OS_VERSION:I = 0x2c1
+
+.field private static final blacklist KM_TAG_ROOT_OF_TRUST:I = 0x2c0
+
+.field private static final blacklist KM_TAG_VENDOR_PATCHLEVEL:I = 0x2ce
+
+.field private static final blacklist KNOX_OID:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+.field private static final blacklist RSA_CERTS:Ljava/util/List;
+    .annotation system Ldalvik/annotation/Signature;
+        value = {
+            "Ljava/util/List<",
+            "Ljava/security/cert/Certificate;",
+            ">;"
+        }
+    .end annotation
+.end field
+
+.field private static final blacklist RSA_PRIVATE_KEY:Ljava/security/PrivateKey;
+
+.field private static final blacklist TAG:Ljava/lang/String; = "KeyStoreHooks"
+
+.field private static final blacklist TEE_ENFORCED_INDEX:I = 0x7
+
+.field private static final blacklist VERIFIED_BOOT_HASH_INDEX:I = 0x3
+
+.field private static final blacklist VERIFIED_BOOT_KEY_INDEX:I
+
+.field private static final blacklist sCertificateFactory:Ljava/security/cert/CertificateFactory;
+
+.field private static final blacklist sHackedCerts:Ljava/util/Map;
+    .annotation system Ldalvik/annotation/Signature;
+        value = {
+            "Ljava/util/Map<",
+            "Ljava/lang/String;",
+            "[B>;"
+        }
+    .end annotation
+.end field
+
+.field private static final blacklist sMessageDigest:Ljava/security/MessageDigest;
+
+.field private static final blacklist sVerifiedBootHash:[B
+
+.field private static final blacklist sVerifiedBootKey:[B
+
+
+# direct methods
+.method static bridge synthetic blacklist -$$Nest$sfgetASN1_OID()Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+    .locals 1
+
+    sget-object v0, Lio/mesalabs/unica/KeyStoreHooks;->ASN1_OID:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    return-object v0
+.end method
+
+.method static bridge synthetic blacklist -$$Nest$sfgetsVerifiedBootHash()[B
+    .locals 1
+
+    sget-object v0, Lio/mesalabs/unica/KeyStoreHooks;->sVerifiedBootHash:[B
+
+    return-object v0
+.end method
+
+.method static bridge synthetic blacklist -$$Nest$smgetByteArrayFromAsn1(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)[B
+    .locals 0
+
+    invoke-static {p0}, Lio/mesalabs/unica/KeyStoreHooks;->getByteArrayFromAsn1(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method static bridge synthetic blacklist -$$Nest$smisAllZeros([B)Z
+    .locals 0
+
+    invoke-static {p0}, Lio/mesalabs/unica/KeyStoreHooks;->isAllZeros([B)Z
+
+    move-result p0
+
+    return p0
+.end method
+
+.method static constructor blacklist <clinit>()V
+    .locals 7
+
+    const-string v0, "-"
+
+    const-string v1, "hash-"
+
+    const-string v2, "key-"
+
+    new-instance v3, Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    const-string v4, "1.3.6.1.4.1.11129.2.1.17"
+
+    invoke-direct {v3, v4}, Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;-><init>(Ljava/lang/String;)V
+
+    sput-object v3, Lio/mesalabs/unica/KeyStoreHooks;->ASN1_OID:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    new-instance v3, Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    const-string v4, "1.3.6.1.4.1.236.11.3.23.7"
+
+    invoke-direct {v3, v4}, Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;-><init>(Ljava/lang/String;)V
+
+    sput-object v3, Lio/mesalabs/unica/KeyStoreHooks;->KNOX_OID:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    new-instance v3, Ljava/util/ArrayList;
+
+    invoke-direct {v3}, Ljava/util/ArrayList;-><init>()V
+
+    sput-object v3, Lio/mesalabs/unica/KeyStoreHooks;->EC_CERTS:Ljava/util/List;
+
+    new-instance v4, Ljava/util/ArrayList;
+
+    invoke-direct {v4}, Ljava/util/ArrayList;-><init>()V
+
+    sput-object v4, Lio/mesalabs/unica/KeyStoreHooks;->RSA_CERTS:Ljava/util/List;
+
+    new-instance v5, Ljava/util/HashMap;
+
+    invoke-direct {v5}, Ljava/util/HashMap;-><init>()V
+
+    sput-object v5, Lio/mesalabs/unica/KeyStoreHooks;->sHackedCerts:Ljava/util/Map;
+
+    :try_start_0
+    const-string v5, "X.509"
+
+    invoke-static {v5}, Ljava/security/cert/CertificateFactory;->getInstance(Ljava/lang/String;)Ljava/security/cert/CertificateFactory;
+
+    move-result-object v5
+
+    sput-object v5, Lio/mesalabs/unica/KeyStoreHooks;->sCertificateFactory:Ljava/security/cert/CertificateFactory;
+
+    const-string v5, "-----BEGIN EC PRIVATE KEY-----\nMHcCAQEEICHghkMqFRmEWc82OlD8FMnarfk19SfC39ceTW28QuVEoAoGCCqGSM49\nAwEHoUQDQgAE6555+EJjWazLKpFMiYbMcK2QZpOCqXMmE/6sy/ghJ0whdJdKKv6l\nuU1/ZtTgZRBmNbxTt6CjpnFYPts+Ea4QFA==\n-----END EC PRIVATE KEY-----\n"
+
+    const/4 v6, 0x1
+
+    invoke-static {v5, v6}, Lio/mesalabs/unica/KeyStoreHooks;->parsePrivateKey(Ljava/lang/String;Z)Ljava/security/PrivateKey;
+
+    move-result-object v5
+
+    sput-object v5, Lio/mesalabs/unica/KeyStoreHooks;->EC_PRIVATE_KEY:Ljava/security/PrivateKey;
+
+    const-string v5, "-----BEGIN CERTIFICATE-----\nMIICeDCCAh6gAwIBAgICEAEwCgYIKoZIzj0EAwIwgZgxCzAJBgNVBAYTAlVTMRMw\nEQYDVQQIDApDYWxpZm9ybmlhMRYwFAYDVQQHDA1Nb3VudGFpbiBWaWV3MRUwEwYD\nVQQKDAxHb29nbGUsIEluYy4xEDAOBgNVBAsMB0FuZHJvaWQxMzAxBgNVBAMMKkFu\nZHJvaWQgS2V5c3RvcmUgU29mdHdhcmUgQXR0ZXN0YXRpb24gUm9vdDAeFw0xNjAx\nMTEwMDQ2MDlaFw0yNjAxMDgwMDQ2MDlaMIGIMQswCQYDVQQGEwJVUzETMBEGA1UE\nCAwKQ2FsaWZvcm5pYTEVMBMGA1UECgwMR29vZ2xlLCBJbmMuMRAwDgYDVQQLDAdB\nbmRyb2lkMTswOQYDVQQDDDJBbmRyb2lkIEtleXN0b3JlIFNvZnR3YXJlIEF0dGVz\ndGF0aW9uIEludGVybWVkaWF0ZTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOue\nefhCY1msyyqRTImGzHCtkGaTgqlzJhP+rMv4ISdMIXSXSir+pblNf2bU4GUQZjW8\nU7ego6ZxWD7bPhGuEBSjZjBkMB0GA1UdDgQWBBQ//KzWGrE6noEguNUlHMVlux6R\nqTAfBgNVHSMEGDAWgBTIrel3TEXDo88NFhDkeUM6IVowzzASBgNVHRMBAf8ECDAG\nAQH/AgEAMA4GA1UdDwEB/wQEAwIChDAKBggqhkjOPQQDAgNIADBFAiBLipt77oK8\nwDOHri/AiZi03cONqycqRZ9pDMfDktQPjgIhAO7aAV229DLp1IQ7YkyUBO86fMy9\nXvsiu+f+uXc/WT/7\n-----END CERTIFICATE-----\n"
+
+    invoke-static {v5}, Lio/mesalabs/unica/KeyStoreHooks;->parseCert(Ljava/lang/String;)Ljava/security/cert/Certificate;
+
+    move-result-object v5
+
+    invoke-interface {v3, v5}, Ljava/util/List;->add(Ljava/lang/Object;)Z
+
+    const-string v5, "-----BEGIN CERTIFICATE-----\nMIICizCCAjKgAwIBAgIJAKIFntEOQ1tXMAoGCCqGSM49BAMCMIGYMQswCQYDVQQG\nEwJVUzETMBEGA1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwNTW91bnRhaW4gVmll\ndzEVMBMGA1UECgwMR29vZ2xlLCBJbmMuMRAwDgYDVQQLDAdBbmRyb2lkMTMwMQYD\nVQQDDCpBbmRyb2lkIEtleXN0b3JlIFNvZnR3YXJlIEF0dGVzdGF0aW9uIFJvb3Qw\nHhcNMTYwMTExMDA0MzUwWhcNMzYwMTA2MDA0MzUwWjCBmDELMAkGA1UEBhMCVVMx\nEzARBgNVBAgMCkNhbGlmb3JuaWExFjAUBgNVBAcMDU1vdW50YWluIFZpZXcxFTAT\nBgNVBAoMDEdvb2dsZSwgSW5jLjEQMA4GA1UECwwHQW5kcm9pZDEzMDEGA1UEAwwq\nQW5kcm9pZCBLZXlzdG9yZSBTb2Z0d2FyZSBBdHRlc3RhdGlvbiBSb290MFkwEwYH\nKoZIzj0CAQYIKoZIzj0DAQcDQgAE7l1ex+HA220Dpn7mthvsTWpdamguD/9/SQ59\ndx9EIm29sa/6FsvHrcV30lacqrewLVQBXT5DKyqO107sSHVBpKNjMGEwHQYDVR0O\nBBYEFMit6XdMRcOjzw0WEOR5QzohWjDPMB8GA1UdIwQYMBaAFMit6XdMRcOjzw0W\nEOR5QzohWjDPMA8GA1UdEwEB/wQFMAMBAf8wDgYDVR0PAQH/BAQDAgKEMAoGCCqG\nSM49BAMCA0cAMEQCIDUho++LNEYenNVg8x1YiSBq3KNlQfYNns6KGYxmSGB7AiBN\nC/NR2TB8fVvaNTQdqEcbY6WFZTytTySn502vQX3xvw==\n-----END CERTIFICATE-----\n"
+
+    invoke-static {v5}, Lio/mesalabs/unica/KeyStoreHooks;->parseCert(Ljava/lang/String;)Ljava/security/cert/Certificate;
+
+    move-result-object v5
+
+    invoke-interface {v3, v5}, Ljava/util/List;->add(Ljava/lang/Object;)Z
+
+    const-string v3, "-----BEGIN RSA PRIVATE KEY-----\nMIICXQIBAAKBgQDAgyPcVogbuDAgafWwhWHG7r5/BeL1qEIEir6LR752/q7yXPKb\nKvoyABQWAUKZiaFfz8aBXrNjWDwv0vIL5Jgyg92BSxbX4YVBeuVKvClqOm21wAQI\nO2jFVsHwIzmRZBmGTVC3TUCuykhMdzVsiVoMJ1q/rEmdXX0jYvKcXgLocQIDAQAB\nAoGBAL6GCwuZqAKm+xpZQ4p7txUGWwmjbcbpysxr88AsNNfXnpTGYGQo2Ix7f2V3\nwc3qZAdKvo5yht8fCBHclygmCGjeldMu/Ja20IT/JxpfYN78xwPno45uKbqaPF/C\nwoB2tqiWrx0014gozpvdsfNPnJQEQweBKY4gExZyW728mTpBAkEA4cbZJ2RsCRbs\nNoJtWUmDdAwh8bB0xKGlmGfGaXlchdPcRkxbkp6Uv7NODcxQFLEPEzQat/3V9gQU\n0qMmytQcxQJBANpIWZd4XNVjD7D9jFJU+Y5TjhiYOq6ea35qWntdNDdVuSGOvUAy\nDSg4fXifdvohi8wti2il9kGPu+ylF5qzr70CQFD+/DJklVlhbtZTThVFCTKdk6PY\nENvlvbmCKSz3i9i624Agro1X9LcdBThv/p6dsnHKNHejSZnbdvjl7OnA1J0CQBW3\nTPJ8zv+Ls2vwTZ2DRrCaL3DS9EObDyasfgP36dH3fUuRX9KbKCPwOstdUgDghX/y\nqAPpPu6W1iNc6VRCvCECQQCQp0XaiXCyzWSWYDJCKMX4KFb/1mW6moXI1g8bi+5x\nfs0scurgHa2GunZU1M9FrbXx8rMdn4Eiz6XxpVcPmy0l\n-----END RSA PRIVATE KEY-----\n"
+
+    const/4 v5, 0x0
+
+    invoke-static {v3, v5}, Lio/mesalabs/unica/KeyStoreHooks;->parsePrivateKey(Ljava/lang/String;Z)Ljava/security/PrivateKey;
+
+    move-result-object v3
+
+    sput-object v3, Lio/mesalabs/unica/KeyStoreHooks;->RSA_PRIVATE_KEY:Ljava/security/PrivateKey;
+
+    const-string v3, "-----BEGIN CERTIFICATE-----\nMIICtjCCAh+gAwIBAgICEAAwDQYJKoZIhvcNAQELBQAwYzELMAkGA1UEBhMCVVMx\nEzARBgNVBAgMCkNhbGlmb3JuaWExFjAUBgNVBAcMDU1vdW50YWluIFZpZXcxFTAT\nBgNVBAoMDEdvb2dsZSwgSW5jLjEQMA4GA1UECwwHQW5kcm9pZDAeFw0xNjAxMDQx\nMjQwNTNaFw0zNTEyMzAxMjQwNTNaMHYxCzAJBgNVBAYTAlVTMRMwEQYDVQQIDApD\nYWxpZm9ybmlhMRUwEwYDVQQKDAxHb29nbGUsIEluYy4xEDAOBgNVBAsMB0FuZHJv\naWQxKTAnBgNVBAMMIEFuZHJvaWQgU29mdHdhcmUgQXR0ZXN0YXRpb24gS2V5MIGf\nMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDAgyPcVogbuDAgafWwhWHG7r5/BeL1\nqEIEir6LR752/q7yXPKbKvoyABQWAUKZiaFfz8aBXrNjWDwv0vIL5Jgyg92BSxbX\n4YVBeuVKvClqOm21wAQIO2jFVsHwIzmRZBmGTVC3TUCuykhMdzVsiVoMJ1q/rEmd\nXX0jYvKcXgLocQIDAQABo2YwZDAdBgNVHQ4EFgQU1AwQG/jNY7n3OVK1DhNcpteZ\nk4YwHwYDVR0jBBgwFoAUKfrxrMxN0kyWQCd1trDpMuUH/i4wEgYDVR0TAQH/BAgw\nBgEB/wIBADAOBgNVHQ8BAf8EBAMCAoQwDQYJKoZIhvcNAQELBQADgYEAni1IX4xn\nM9waha2Z11Aj6hTsQ7DhnerCI0YecrUZ3GAi5KVoMWwLVcTmnKItnzpPk2sxixZ4\nFg2Iy9mLzICdhPDCJ+NrOPH90ecXcjFZNX2W88V/q52PlmEmT7K+gbsNSQQiis6f\n9/VCLiVE+iEHElqDtVWtGIL4QBSbnCBjBH8=\n-----END CERTIFICATE-----\n"
+
+    invoke-static {v3}, Lio/mesalabs/unica/KeyStoreHooks;->parseCert(Ljava/lang/String;)Ljava/security/cert/Certificate;
+
+    move-result-object v3
+
+    invoke-interface {v4, v3}, Ljava/util/List;->add(Ljava/lang/Object;)Z
+
+    const-string v3, "-----BEGIN CERTIFICATE-----\nMIICpzCCAhCgAwIBAgIJAP+U2d2fB8gMMA0GCSqGSIb3DQEBCwUAMGMxCzAJBgNV\nBAYTAlVTMRMwEQYDVQQIDApDYWxpZm9ybmlhMRYwFAYDVQQHDA1Nb3VudGFpbiBW\naWV3MRUwEwYDVQQKDAxHb29nbGUsIEluYy4xEDAOBgNVBAsMB0FuZHJvaWQwHhcN\nMTYwMTA0MTIzMTA4WhcNMzUxMjMwMTIzMTA4WjBjMQswCQYDVQQGEwJVUzETMBEG\nA1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwNTW91bnRhaW4gVmlldzEVMBMGA1UE\nCgwMR29vZ2xlLCBJbmMuMRAwDgYDVQQLDAdBbmRyb2lkMIGfMA0GCSqGSIb3DQEB\nAQUAA4GNADCBiQKBgQCia63rbi5EYe/VDoLmt5TRdSMfd5tjkWP/96r/C3JHTsAs\nQ+wzfNes7UA+jCigZtX3hwszl94OuE4TQKuvpSe/lWmgMdsGUmX4RFlXYfC78hdL\nt0GAZMAoDo9Sd47b0ke2RekZyOmLw9vCkT/X11DEHTVm+Vfkl5YLCazOkjWFmwID\nAQABo2MwYTAdBgNVHQ4EFgQUKfrxrMxN0kyWQCd1trDpMuUH/i4wHwYDVR0jBBgw\nFoAUKfrxrMxN0kyWQCd1trDpMuUH/i4wDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8B\nAf8EBAMCAoQwDQYJKoZIhvcNAQELBQADgYEAT3LzNlmNDsG5dFsxWfbwjSVJMJ6j\nHBwp0kUtILlNX2S06IDHeHqcOd6os/W/L3BfRxBcxebrTQaZYdKumgf/93y4q+uc\nDyQHXrF/unlx/U1bnt8Uqf7f7XzAiF343ZtkMlbVNZriE/mPzsF83O+kqrJVw4Op\nLvtc9mL1J1IXvmM=\n-----END CERTIFICATE-----\n"
+
+    invoke-static {v3}, Lio/mesalabs/unica/KeyStoreHooks;->parseCert(Ljava/lang/String;)Ljava/security/cert/Certificate;
+
+    move-result-object v3
+
+    invoke-interface {v4, v3}, Ljava/util/List;->add(Ljava/lang/Object;)Z
+
+    const-string v3, "SHA-256"
+
+    invoke-static {v3}, Ljava/security/MessageDigest;->getInstance(Ljava/lang/String;)Ljava/security/MessageDigest;
+
+    move-result-object v3
+
+    sput-object v3, Lio/mesalabs/unica/KeyStoreHooks;->sMessageDigest:Ljava/security/MessageDigest;
+
+    new-instance v4, Ljava/lang/StringBuilder;
+
+    invoke-direct {v4, v2}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
+
+    sget-object v2, Landroid/os/Build$VERSION;->INCREMENTAL:Ljava/lang/String;
+
+    invoke-virtual {v4, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v2
+
+    invoke-virtual {v2, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v2
+
+    sget-object v4, Landroid/os/Build;->BOARD:Ljava/lang/String;
+
+    invoke-virtual {v2, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v2
+
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v2
+
+    sget-object v4, Ljava/nio/charset/StandardCharsets;->UTF_8:Ljava/nio/charset/Charset;
+
+    invoke-virtual {v2, v4}, Ljava/lang/String;->getBytes(Ljava/nio/charset/Charset;)[B
+
+    move-result-object v2
+
+    invoke-virtual {v3, v2}, Ljava/security/MessageDigest;->digest([B)[B
+
+    move-result-object v2
+
+    sput-object v2, Lio/mesalabs/unica/KeyStoreHooks;->sVerifiedBootKey:[B
+
+    const-string v2, "ro.boot.vbmeta.digest"
+
+    const-string v4, ""
+
+    invoke-static {v2, v4}, Landroid/os/SystemProperties;->get(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-static {v2}, Landroid/text/TextUtils;->isEmpty(Ljava/lang/CharSequence;)Z
+
+    move-result v4
+
+    if-nez v4, :cond_0
+
+    invoke-virtual {v2}, Ljava/lang/String;->length()I
+
+    move-result v4
+
+    const/16 v5, 0x40
+
+    if-ne v4, v5, :cond_0
+
+    invoke-static {}, Ljava/util/HexFormat;->of()Ljava/util/HexFormat;
+
+    move-result-object v0
+
+    invoke-virtual {v0, v2}, Ljava/util/HexFormat;->parseHex(Ljava/lang/CharSequence;)[B
+
+    move-result-object v0
+
+    sput-object v0, Lio/mesalabs/unica/KeyStoreHooks;->sVerifiedBootHash:[B
+
+    goto :goto_0
+
+    :cond_0
+    new-instance v2, Ljava/lang/StringBuilder;
+
+    invoke-direct {v2, v1}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
+
+    sget-object v1, Landroid/os/Build$VERSION;->INCREMENTAL:Ljava/lang/String;
+
+    invoke-virtual {v2, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v1
+
+    invoke-virtual {v1, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v0
+
+    sget-object v1, Landroid/os/Build;->BOARD:Ljava/lang/String;
+
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    sget-object v1, Ljava/nio/charset/StandardCharsets;->UTF_8:Ljava/nio/charset/Charset;
+
+    invoke-virtual {v0, v1}, Ljava/lang/String;->getBytes(Ljava/nio/charset/Charset;)[B
+
+    move-result-object v0
+
+    invoke-virtual {v3, v0}, Ljava/security/MessageDigest;->digest([B)[B
+
+    move-result-object v0
+
+    sput-object v0, Lio/mesalabs/unica/KeyStoreHooks;->sVerifiedBootHash:[B
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
+
+    :goto_0
+    return-void
+
+    :catch_0
+    move-exception v0
+
+    new-instance v1, Ljava/lang/RuntimeException;
+
+    invoke-direct {v1, v0}, Ljava/lang/RuntimeException;-><init>(Ljava/lang/Throwable;)V
+
+    throw v1
+.end method
+
+.method private constructor blacklist <init>()V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    return-void
+.end method
+
+.method public static blacklist dlog(Ljava/lang/String;)V
+    .locals 0
+
+    return-void
+.end method
+
+.method private static blacklist getByteArrayFromAsn1(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)[B
+    .locals 1
+    .annotation system Ldalvik/annotation/Throws;
+        value = {
+            Ljava/security/cert/CertificateParsingException;
+        }
+    .end annotation
+
+    instance-of v0, p0, Lcom/android/internal/org/bouncycastle/asn1/DEROctetString;
+
+    if-eqz v0, :cond_0
+
+    check-cast p0, Lcom/android/internal/org/bouncycastle/asn1/DEROctetString;
+
+    invoke-virtual {p0}, Lcom/android/internal/org/bouncycastle/asn1/DEROctetString;->getOctets()[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
+    new-instance p0, Ljava/security/cert/CertificateParsingException;
+
+    const-string v0, "Expected DEROctetString"
+
+    invoke-direct {p0, v0}, Ljava/security/cert/CertificateParsingException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+.end method
+
+.method private static blacklist getKeyFactory(Ljava/lang/String;)Ljava/security/KeyFactory;
+    .locals 2
+    .annotation system Ldalvik/annotation/Throws;
+        value = {
+            Ljava/security/NoSuchAlgorithmException;
+        }
+    .end annotation
+
+    :try_start_0
+    invoke-static {p0}, Ljava/security/KeyFactory;->getInstance(Ljava/lang/String;)Ljava/security/KeyFactory;
+
+    move-result-object p0
+    :try_end_0
+    .catch Ljava/security/NoSuchAlgorithmException; {:try_start_0 .. :try_end_0} :catch_0
+
+    return-object p0
+
+    :catch_0
+    move-exception v0
+
+    const-string v1, "ECDSA"
+
+    invoke-virtual {p0, v1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result p0
+
+    if-eqz p0, :cond_0
+
+    const-string p0, "EC"
+
+    invoke-static {p0}, Ljava/security/KeyFactory;->getInstance(Ljava/lang/String;)Ljava/security/KeyFactory;
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
+    throw v0
+.end method
+
+.method private static blacklist getSecurityPatchLevel(Z)I
+    .locals 3
+
+    :try_start_0
+    sget-object v0, Landroid/os/Build$VERSION;->SECURITY_PATCH:Ljava/lang/String;
+
+    const-string v1, "-"
+
+    invoke-virtual {v0, v1}, Ljava/lang/String;->split(Ljava/lang/String;)[Ljava/lang/String;
+
+    move-result-object v0
+
+    const/4 v1, 0x1
+
+    const/4 v2, 0x0
+
+    if-eqz p0, :cond_0
+
+    aget-object v2, v0, v2
+
+    invoke-static {v2}, Ljava/lang/Integer;->parseInt(Ljava/lang/String;)I
+
+    move-result v2
+
+    mul-int/lit16 v2, v2, 0x2710
+
+    aget-object v1, v0, v1
+
+    invoke-static {v1}, Ljava/lang/Integer;->parseInt(Ljava/lang/String;)I
+
+    move-result v1
+
+    mul-int/lit8 v1, v1, 0x64
+
+    add-int/2addr v2, v1
+
+    const/4 v1, 0x2
+
+    aget-object v0, v0, v1
+
+    invoke-static {v0}, Ljava/lang/Integer;->parseInt(Ljava/lang/String;)I
+
+    move-result p0
+
+    add-int/2addr v2, p0
+
+    return v2
+
+    :cond_0
+    aget-object v2, v0, v2
+
+    invoke-static {v2}, Ljava/lang/Integer;->parseInt(Ljava/lang/String;)I
+
+    move-result v2
+
+    mul-int/lit8 v2, v2, 0x64
+
+    aget-object v0, v0, v1
+
+    invoke-static {v0}, Ljava/lang/Integer;->parseInt(Ljava/lang/String;)I
+
+    move-result p0
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
+
+    add-int/2addr v2, p0
+
+    return v2
+
+    :catch_0
+    if-eqz p0, :cond_1
+
+    const p0, 0x134d6e5
+
+    goto :goto_0
+
+    :cond_1
+    const p0, 0x316a1
+
+    :goto_0
+    return p0
+.end method
+
+.method public static blacklist handleCertificateChain([B)[B
+    .locals 7
+
+    const-string v0, "unsupported algorithm "
+
+    invoke-static {}, Lio/mesalabs/unica/KeyStoreHooks;->isPIFEnabled()Z
+
+    move-result v1
+
+    if-eqz v1, :cond_7
+
+    if-nez p0, :cond_0
+
+    goto/16 :goto_2
+
+    :cond_0
+    :try_start_0
+    sget-object v1, Lio/mesalabs/unica/KeyStoreHooks;->sCertificateFactory:Ljava/security/cert/CertificateFactory;
+
+    new-instance v2, Ljava/io/ByteArrayInputStream;
+
+    invoke-direct {v2, p0}, Ljava/io/ByteArrayInputStream;-><init>([B)V
+
+    invoke-virtual {v1, v2}, Ljava/security/cert/CertificateFactory;->generateCertificates(Ljava/io/InputStream;)Ljava/util/Collection;
+
+    move-result-object v1
+
+    const/4 v2, 0x0
+
+    new-array v3, v2, [Ljava/security/cert/X509Certificate;
+
+    invoke-interface {v1, v3}, Ljava/util/Collection;->toArray([Ljava/lang/Object;)[Ljava/lang/Object;
+
+    move-result-object v1
+
+    check-cast v1, [Ljava/security/cert/X509Certificate;
+
+    array-length v3, v1
+
+    add-int/lit8 v3, v3, -0x1
+
+    aget-object v3, v1, v3
+
+    invoke-virtual {v3}, Ljava/security/cert/X509Certificate;->getPublicKey()Ljava/security/PublicKey;
+
+    move-result-object v3
+
+    invoke-interface {v3}, Ljava/security/PublicKey;->getEncoded()[B
+
+    move-result-object v3
+
+    const-string v4, "MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAr7bHgiuxpwHsK7Qui8xUFmOr75gvMsd/dTEDDJdSSxtf6An7xyqpRR90PL2abxM1dEqlXnf2tqw1Ne4Xwl5jlRfdnJLmN0pTy/4lj4/7tv0Sk3iiKkypnEUtR6WfMgH0QZfKHM1+di+y9TFRtv6y//0rb+T+W8a9nsNL/ggjnar86461qO0rOs2cXjp3kOG1FEJ5MVmFmBGtnrKpa73XpXyTqRxB/M0n1n/W9nGqC4FSYa04T6N5RIZGBN2z2MT5IKGbFlbC8UrW0DxW7AYImQQcHtGl/m00QLVWutHQoVJYnFPlXTcHYvASLu+RhhsbDmxMgJJ0mcDpvsC4PjvB+TxywElgS70vE0XmLD+OJtvsBslHZvPBKCOdT0MS+tgSOIfga+z1Z1g7+DVagf7quvmag8jfPioyKvxnK/EgsTUVi2ghzq8wm27ud/mIM7AY2qEORR8Go3TVB4HzWQgpZrt3i5MIlCaY504LzSRiigHCzAPlHws+W0rB5N+er5/2pJKnfBSDiCiFAVtCLOZ7gLiMm0jhO2B6tUXHI/+MRPjy02i59lINMRRev56GKtcd9qO/0kUJWdZTdA2XoS82ixPvZtXQpUpuL12ab+9EaDK8Z4RHJYYfCT3Q5vNAXaiWQ+8PTWm2QgBR/bkwSWc+NpUFgNPN9PvQi8WEg5UmAGMCAwEAAQ=="
+
+    invoke-static {v4, v2}, Landroid/util/Base64;->decode(Ljava/lang/String;I)[B
+
+    move-result-object v4
+
+    invoke-static {v3, v4}, Ljava/util/Arrays;->equals([B[B)Z
+
+    move-result v3
+
+    if-nez v3, :cond_1
+
+    const-string v0, "Not a GAK key"
+
+    invoke-static {v0}, Lio/mesalabs/unica/KeyStoreHooks;->dlog(Ljava/lang/String;)V
+
+    return-object p0
+
+    :cond_1
+    new-instance v3, Ljava/util/ArrayList;
+
+    invoke-direct {v3}, Ljava/util/ArrayList;-><init>()V
+
+    const-string v4, "EC"
+
+    aget-object v5, v1, v2
+
+    invoke-virtual {v5}, Ljava/security/cert/X509Certificate;->getPublicKey()Ljava/security/PublicKey;
+
+    move-result-object v5
+
+    invoke-interface {v5}, Ljava/security/PublicKey;->getAlgorithm()Ljava/lang/String;
+
+    move-result-object v5
+
+    invoke-virtual {v4, v5}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v4
+
+    if-eqz v4, :cond_3
+
+    sget-object v0, Lio/mesalabs/unica/KeyStoreHooks;->EC_CERTS:Ljava/util/List;
+
+    invoke-interface {v0}, Ljava/util/List;->iterator()Ljava/util/Iterator;
+
+    move-result-object v0
+
+    :cond_2
+    invoke-interface {v0}, Ljava/util/Iterator;->hasNext()Z
+
+    move-result v1
+
+    if-eqz v1, :cond_5
+
+    invoke-interface {v0}, Ljava/util/Iterator;->next()Ljava/lang/Object;
+
+    move-result-object v1
+
+    check-cast v1, Ljava/security/cert/Certificate;
+
+    invoke-virtual {v1}, Ljava/security/cert/Certificate;->getEncoded()[B
+
+    move-result-object v1
+
+    array-length v4, v1
+
+    move v5, v2
+
+    :goto_0
+    if-ge v5, v4, :cond_2
+
+    aget-byte v6, v1, v5
+
+    invoke-static {v6}, Ljava/lang/Byte;->valueOf(B)Ljava/lang/Byte;
+
+    move-result-object v6
+
+    invoke-interface {v3, v6}, Ljava/util/List;->add(Ljava/lang/Object;)Z
+
+    add-int/lit8 v5, v5, 0x1
+
+    goto :goto_0
+
+    :cond_3
+    const-string v4, "RSA"
+
+    aget-object v5, v1, v2
+
+    invoke-virtual {v5}, Ljava/security/cert/X509Certificate;->getPublicKey()Ljava/security/PublicKey;
+
+    move-result-object v5
+
+    invoke-interface {v5}, Ljava/security/PublicKey;->getAlgorithm()Ljava/lang/String;
+
+    move-result-object v5
+
+    invoke-virtual {v4, v5}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v4
+
+    if-eqz v4, :cond_6
+
+    sget-object v0, Lio/mesalabs/unica/KeyStoreHooks;->RSA_CERTS:Ljava/util/List;
+
+    invoke-interface {v0}, Ljava/util/List;->iterator()Ljava/util/Iterator;
+
+    move-result-object v0
+
+    :cond_4
+    invoke-interface {v0}, Ljava/util/Iterator;->hasNext()Z
+
+    move-result v1
+
+    if-eqz v1, :cond_5
+
+    invoke-interface {v0}, Ljava/util/Iterator;->next()Ljava/lang/Object;
+
+    move-result-object v1
+
+    check-cast v1, Ljava/security/cert/Certificate;
+
+    invoke-virtual {v1}, Ljava/security/cert/Certificate;->getEncoded()[B
+
+    move-result-object v1
+
+    array-length v4, v1
+
+    move v5, v2
+
+    :goto_1
+    if-ge v5, v4, :cond_4
+
+    aget-byte v6, v1, v5
+
+    invoke-static {v6}, Ljava/lang/Byte;->valueOf(B)Ljava/lang/Byte;
+
+    move-result-object v6
+
+    invoke-interface {v3, v6}, Ljava/util/List;->add(Ljava/lang/Object;)Z
+
+    add-int/lit8 v5, v5, 0x1
+
+    goto :goto_1
+
+    :cond_5
+    new-array v0, v2, [Ljava/lang/Byte;
+
+    invoke-interface {v3, v0}, Ljava/util/List;->toArray([Ljava/lang/Object;)[Ljava/lang/Object;
+
+    move-result-object v0
+
+    check-cast v0, [Ljava/lang/Byte;
+
+    invoke-static {v0}, Lio/mesalabs/unica/KeyStoreHooks;->toPrimitive([Ljava/lang/Byte;)[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_6
+    new-instance v3, Ljava/lang/UnsupportedOperationException;
+
+    new-instance v4, Ljava/lang/StringBuilder;
+
+    invoke-direct {v4, v0}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
+
+    aget-object v0, v1, v2
+
+    invoke-virtual {v0}, Ljava/security/cert/X509Certificate;->getPublicKey()Ljava/security/PublicKey;
+
+    move-result-object v0
+
+    invoke-interface {v0}, Ljava/security/PublicKey;->getAlgorithm()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-virtual {v4, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-direct {v3, v0}, Ljava/lang/UnsupportedOperationException;-><init>(Ljava/lang/String;)V
+
+    throw v3
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
+
+    :catch_0
+    move-exception v0
+
+    invoke-virtual {v0}, Ljava/lang/Exception;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lio/mesalabs/unica/KeyStoreHooks;->dlog(Ljava/lang/String;)V
+
+    :cond_7
+    :goto_2
+    return-object p0
+.end method
+
+.method public static blacklist handleLeafCertificate([B)[B
+    .locals 24
+
+    move-object/from16 v1, p0
+
+    invoke-static {}, Lio/mesalabs/unica/KeyStoreHooks;->isPIFEnabled()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_11
+
+    if-nez v1, :cond_0
+
+    goto/16 :goto_9
+
+    :cond_0
+    invoke-static {}, Ljava/util/HexFormat;->of()Ljava/util/HexFormat;
+
+    move-result-object v0
+
+    sget-object v2, Lio/mesalabs/unica/KeyStoreHooks;->sMessageDigest:Ljava/security/MessageDigest;
+
+    invoke-virtual {v2, v1}, Ljava/security/MessageDigest;->digest([B)[B
+
+    move-result-object v2
+
+    invoke-virtual {v0, v2}, Ljava/util/HexFormat;->formatHex([B)Ljava/lang/String;
+
+    move-result-object v2
+
+    sget-object v0, Lio/mesalabs/unica/KeyStoreHooks;->sHackedCerts:Ljava/util/Map;
+
+    invoke-interface {v0, v2}, Ljava/util/Map;->containsKey(Ljava/lang/Object;)Z
+
+    move-result v3
+
+    if-eqz v3, :cond_1
+
+    invoke-interface {v0, v2}, Ljava/util/Map;->get(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object v0
+
+    check-cast v0, [B
+
+    return-object v0
+
+    :cond_1
+    :try_start_0
+    sget-object v0, Lio/mesalabs/unica/KeyStoreHooks;->sCertificateFactory:Ljava/security/cert/CertificateFactory;
+
+    new-instance v3, Ljava/io/ByteArrayInputStream;
+
+    invoke-direct {v3, v1}, Ljava/io/ByteArrayInputStream;-><init>([B)V
+
+    invoke-virtual {v0, v3}, Ljava/security/cert/CertificateFactory;->generateCertificate(Ljava/io/InputStream;)Ljava/security/cert/Certificate;
+
+    move-result-object v0
+
+    check-cast v0, Ljava/security/cert/X509Certificate;
+
+    sget-object v3, Lio/mesalabs/unica/KeyStoreHooks;->ASN1_OID:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    invoke-virtual {v3}, Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;->getId()Ljava/lang/String;
+
+    move-result-object v4
+
+    invoke-virtual {v0, v4}, Ljava/security/cert/X509Certificate;->getExtensionValue(Ljava/lang/String;)[B
+
+    move-result-object v4
+
+    if-eqz v4, :cond_10
+
+    sget-object v4, Lio/mesalabs/unica/KeyStoreHooks;->KNOX_OID:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;->getId()Ljava/lang/String;
+
+    move-result-object v4
+
+    invoke-virtual {v0, v4}, Ljava/security/cert/X509Certificate;->getExtensionValue(Ljava/lang/String;)[B
+
+    move-result-object v4
+
+    if-eqz v4, :cond_2
+
+    goto/16 :goto_8
+
+    :cond_2
+    new-instance v4, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;
+
+    invoke-virtual {v0}, Ljava/security/cert/X509Certificate;->getEncoded()[B
+
+    move-result-object v5
+
+    invoke-direct {v4, v5}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;-><init>([B)V
+
+    invoke-virtual {v4, v3}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getExtension(Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;)Lcom/android/internal/org/bouncycastle/asn1/x509/Extension;
+
+    move-result-object v3
+
+    invoke-virtual {v3}, Lcom/android/internal/org/bouncycastle/asn1/x509/Extension;->getExtnValue()Lcom/android/internal/org/bouncycastle/asn1/ASN1OctetString;
+
+    move-result-object v3
+
+    invoke-virtual {v3}, Lcom/android/internal/org/bouncycastle/asn1/ASN1OctetString;->getOctets()[B
+
+    move-result-object v3
+
+    invoke-static {v3}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->getInstance(Ljava/lang/Object;)Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;
+
+    move-result-object v3
+
+    invoke-virtual {v3}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->toArray()[Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;
+
+    move-result-object v3
+
+    new-instance v5, Lcom/android/internal/org/bouncycastle/asn1/ASN1EncodableVector;
+
+    invoke-direct {v5}, Lcom/android/internal/org/bouncycastle/asn1/ASN1EncodableVector;-><init>()V
+
+    const/4 v6, 0x7
+
+    aget-object v7, v3, v6
+
+    check-cast v7, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;
+
+    invoke-virtual {v7}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->iterator()Ljava/util/Iterator;
+
+    move-result-object v7
+
+    const/4 v9, 0x0
+
+    :cond_3
+    :goto_0
+    invoke-interface {v7}, Ljava/util/Iterator;->hasNext()Z
+
+    move-result v10
+
+    const/16 v11, 0x2ce
+
+    const/16 v12, 0x2cf
+
+    const/16 v13, 0x2c2
+
+    const/16 v14, 0x2c1
+
+    const/16 v15, 0x2c0
+
+    if-eqz v10, :cond_6
+
+    invoke-interface {v7}, Ljava/util/Iterator;->next()Ljava/lang/Object;
+
+    move-result-object v10
+
+    check-cast v10, Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;
+
+    check-cast v10, Lcom/android/internal/org/bouncycastle/asn1/ASN1TaggedObject;
+
+    invoke-virtual {v10}, Lcom/android/internal/org/bouncycastle/asn1/ASN1TaggedObject;->getTagNo()I
+
+    move-result v8
+
+    if-ne v8, v15, :cond_4
+
+    invoke-virtual {v10}, Lcom/android/internal/org/bouncycastle/asn1/ASN1TaggedObject;->getObject()Lcom/android/internal/org/bouncycastle/asn1/ASN1Primitive;
+
+    move-result-object v9
+
+    goto :goto_0
+
+    :cond_4
+    invoke-virtual {v10}, Lcom/android/internal/org/bouncycastle/asn1/ASN1TaggedObject;->getTagNo()I
+
+    move-result v8
+
+    if-eq v8, v14, :cond_3
+
+    invoke-virtual {v10}, Lcom/android/internal/org/bouncycastle/asn1/ASN1TaggedObject;->getTagNo()I
+
+    move-result v8
+
+    if-eq v8, v13, :cond_3
+
+    invoke-virtual {v10}, Lcom/android/internal/org/bouncycastle/asn1/ASN1TaggedObject;->getTagNo()I
+
+    move-result v8
+
+    if-eq v8, v12, :cond_3
+
+    invoke-virtual {v10}, Lcom/android/internal/org/bouncycastle/asn1/ASN1TaggedObject;->getTagNo()I
+
+    move-result v8
+
+    if-ne v8, v11, :cond_5
+
+    goto :goto_0
+
+    :cond_5
+    invoke-virtual {v5, v10}, Lcom/android/internal/org/bouncycastle/asn1/ASN1EncodableVector;->add(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    goto :goto_0
+
+    :cond_6
+    const-string v7, "EC"
+
+    invoke-virtual {v0}, Ljava/security/cert/X509Certificate;->getPublicKey()Ljava/security/PublicKey;
+
+    move-result-object v8
+
+    invoke-interface {v8}, Ljava/security/PublicKey;->getAlgorithm()Ljava/lang/String;
+
+    move-result-object v8
+
+    invoke-virtual {v7, v8}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v7
+
+    const/4 v8, 0x0
+
+    if-eqz v7, :cond_7
+
+    new-instance v7, Lcom/android/internal/org/bouncycastle/cert/X509v3CertificateBuilder;
+
+    new-instance v10, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;
+
+    sget-object v6, Lio/mesalabs/unica/KeyStoreHooks;->EC_CERTS:Ljava/util/List;
+
+    invoke-interface {v6, v8}, Ljava/util/List;->get(I)Ljava/lang/Object;
+
+    move-result-object v6
+
+    check-cast v6, Ljava/security/cert/Certificate;
+
+    invoke-virtual {v6}, Ljava/security/cert/Certificate;->getEncoded()[B
+
+    move-result-object v6
+
+    invoke-direct {v10, v6}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;-><init>([B)V
+
+    invoke-virtual {v10}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getSubject()Lcom/android/internal/org/bouncycastle/asn1/x500/X500Name;
+
+    move-result-object v18
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getSerialNumber()Ljava/math/BigInteger;
+
+    move-result-object v19
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getNotBefore()Ljava/util/Date;
+
+    move-result-object v20
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getNotAfter()Ljava/util/Date;
+
+    move-result-object v21
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getSubject()Lcom/android/internal/org/bouncycastle/asn1/x500/X500Name;
+
+    move-result-object v22
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getSubjectPublicKeyInfo()Lcom/android/internal/org/bouncycastle/asn1/x509/SubjectPublicKeyInfo;
+
+    move-result-object v23
+
+    move-object/from16 v17, v7
+
+    invoke-direct/range {v17 .. v23}, Lcom/android/internal/org/bouncycastle/cert/X509v3CertificateBuilder;-><init>(Lcom/android/internal/org/bouncycastle/asn1/x500/X500Name;Ljava/math/BigInteger;Ljava/util/Date;Ljava/util/Date;Lcom/android/internal/org/bouncycastle/asn1/x500/X500Name;Lcom/android/internal/org/bouncycastle/asn1/x509/SubjectPublicKeyInfo;)V
+
+    new-instance v6, Lcom/android/internal/org/bouncycastle/operator/jcajce/JcaContentSignerBuilder;
+
+    invoke-virtual {v0}, Ljava/security/cert/X509Certificate;->getSigAlgName()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-direct {v6, v0}, Lcom/android/internal/org/bouncycastle/operator/jcajce/JcaContentSignerBuilder;-><init>(Ljava/lang/String;)V
+
+    sget-object v0, Lio/mesalabs/unica/KeyStoreHooks;->EC_PRIVATE_KEY:Ljava/security/PrivateKey;
+
+    invoke-virtual {v6, v0}, Lcom/android/internal/org/bouncycastle/operator/jcajce/JcaContentSignerBuilder;->build(Ljava/security/PrivateKey;)Lcom/android/internal/org/bouncycastle/operator/ContentSigner;
+
+    move-result-object v0
+
+    :goto_1
+    move-object v6, v0
+
+    goto :goto_2
+
+    :cond_7
+    const-string v6, "RSA"
+
+    invoke-virtual {v0}, Ljava/security/cert/X509Certificate;->getPublicKey()Ljava/security/PublicKey;
+
+    move-result-object v7
+
+    invoke-interface {v7}, Ljava/security/PublicKey;->getAlgorithm()Ljava/lang/String;
+
+    move-result-object v7
+
+    invoke-virtual {v6, v7}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v6
+
+    if-eqz v6, :cond_f
+
+    new-instance v7, Lcom/android/internal/org/bouncycastle/cert/X509v3CertificateBuilder;
+
+    new-instance v6, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;
+
+    sget-object v10, Lio/mesalabs/unica/KeyStoreHooks;->RSA_CERTS:Ljava/util/List;
+
+    invoke-interface {v10, v8}, Ljava/util/List;->get(I)Ljava/lang/Object;
+
+    move-result-object v10
+
+    check-cast v10, Ljava/security/cert/Certificate;
+
+    invoke-virtual {v10}, Ljava/security/cert/Certificate;->getEncoded()[B
+
+    move-result-object v10
+
+    invoke-direct {v6, v10}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;-><init>([B)V
+
+    invoke-virtual {v6}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getSubject()Lcom/android/internal/org/bouncycastle/asn1/x500/X500Name;
+
+    move-result-object v18
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getSerialNumber()Ljava/math/BigInteger;
+
+    move-result-object v19
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getNotBefore()Ljava/util/Date;
+
+    move-result-object v20
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getNotAfter()Ljava/util/Date;
+
+    move-result-object v21
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getSubject()Lcom/android/internal/org/bouncycastle/asn1/x500/X500Name;
+
+    move-result-object v22
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getSubjectPublicKeyInfo()Lcom/android/internal/org/bouncycastle/asn1/x509/SubjectPublicKeyInfo;
+
+    move-result-object v23
+
+    move-object/from16 v17, v7
+
+    invoke-direct/range {v17 .. v23}, Lcom/android/internal/org/bouncycastle/cert/X509v3CertificateBuilder;-><init>(Lcom/android/internal/org/bouncycastle/asn1/x500/X500Name;Ljava/math/BigInteger;Ljava/util/Date;Ljava/util/Date;Lcom/android/internal/org/bouncycastle/asn1/x500/X500Name;Lcom/android/internal/org/bouncycastle/asn1/x509/SubjectPublicKeyInfo;)V
+
+    new-instance v6, Lcom/android/internal/org/bouncycastle/operator/jcajce/JcaContentSignerBuilder;
+
+    invoke-virtual {v0}, Ljava/security/cert/X509Certificate;->getSigAlgName()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-direct {v6, v0}, Lcom/android/internal/org/bouncycastle/operator/jcajce/JcaContentSignerBuilder;-><init>(Ljava/lang/String;)V
+
+    sget-object v0, Lio/mesalabs/unica/KeyStoreHooks;->RSA_PRIVATE_KEY:Ljava/security/PrivateKey;
+
+    invoke-virtual {v6, v0}, Lcom/android/internal/org/bouncycastle/operator/jcajce/JcaContentSignerBuilder;->build(Ljava/security/PrivateKey;)Lcom/android/internal/org/bouncycastle/operator/ContentSigner;
+
+    move-result-object v0
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_3
+
+    goto :goto_1
+
+    :goto_2
+    const/4 v10, 0x3
+
+    :try_start_1
+    instance-of v0, v9, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;
+
+    if-eqz v0, :cond_a
+
+    check-cast v9, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;
+
+    invoke-virtual {v9, v8}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->getObjectAt(I)Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lio/mesalabs/unica/KeyStoreHooks;->getByteArrayFromAsn1(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)[B
+
+    move-result-object v17
+    :try_end_1
+    .catch Ljava/lang/Exception; {:try_start_1 .. :try_end_1} :catch_2
+
+    :try_start_2
+    invoke-virtual {v9, v10}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->getObjectAt(I)Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lio/mesalabs/unica/KeyStoreHooks;->getByteArrayFromAsn1(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)[B
+
+    move-result-object v9
+    :try_end_2
+    .catch Ljava/lang/Exception; {:try_start_2 .. :try_end_2} :catch_1
+
+    :try_start_3
+    invoke-static/range {v17 .. v17}, Lio/mesalabs/unica/KeyStoreHooks;->isAllZeros([B)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_8
+
+    const/16 v17, 0x0
+
+    :cond_8
+    invoke-static {v9}, Lio/mesalabs/unica/KeyStoreHooks;->isAllZeros([B)Z
+
+    move-result v0
+    :try_end_3
+    .catch Ljava/lang/Exception; {:try_start_3 .. :try_end_3} :catch_0
+
+    if-eqz v0, :cond_9
+
+    const/16 v16, 0x0
+
+    goto :goto_3
+
+    :cond_9
+    move-object/from16 v16, v9
+
+    :goto_3
+    move-object/from16 v0, v17
+
+    goto :goto_5
+
+    :catch_0
+    move-exception v0
+
+    move-object/from16 v16, v17
+
+    goto :goto_4
+
+    :catch_1
+    move-exception v0
+
+    move-object/from16 v16, v17
+
+    const/4 v9, 0x0
+
+    goto :goto_4
+
+    :cond_a
+    :try_start_4
+    new-instance v0, Ljava/security/cert/CertificateParsingException;
+
+    new-instance v11, Ljava/lang/StringBuilder;
+
+    invoke-direct {v11}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v12, "Expected sequence for root of trust, found "
+
+    invoke-virtual {v11, v12}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v11
+
+    invoke-virtual {v9}, Ljava/lang/Object;->getClass()Ljava/lang/Class;
+
+    move-result-object v9
+
+    invoke-virtual {v9}, Ljava/lang/Class;->getName()Ljava/lang/String;
+
+    move-result-object v9
+
+    invoke-virtual {v11, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v9
+
+    invoke-virtual {v9}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v9
+
+    invoke-direct {v0, v9}, Ljava/security/cert/CertificateParsingException;-><init>(Ljava/lang/String;)V
+
+    throw v0
+    :try_end_4
+    .catch Ljava/lang/Exception; {:try_start_4 .. :try_end_4} :catch_2
+
+    :catch_2
+    move-exception v0
+
+    const/4 v9, 0x0
+
+    const/16 v16, 0x0
+
+    :goto_4
+    :try_start_5
+    new-instance v11, Ljava/lang/StringBuilder;
+
+    invoke-direct {v11}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v12, "Failed to get original verified boot key/hash: "
+
+    invoke-virtual {v11, v12}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v11
+
+    invoke-virtual {v0}, Ljava/lang/Object;->getClass()Ljava/lang/Class;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Ljava/lang/Class;->getName()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-virtual {v11, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lio/mesalabs/unica/KeyStoreHooks;->dlog(Ljava/lang/String;)V
+
+    move-object/from16 v0, v16
+
+    move-object/from16 v16, v9
+
+    :goto_5
+    if-nez v0, :cond_b
+
+    sget-object v0, Lio/mesalabs/unica/KeyStoreHooks;->sVerifiedBootKey:[B
+
+    :cond_b
+    if-nez v16, :cond_c
+
+    sget-object v16, Lio/mesalabs/unica/KeyStoreHooks;->sVerifiedBootHash:[B
+
+    :cond_c
+    move-object/from16 v9, v16
+
+    new-instance v11, Lcom/android/internal/org/bouncycastle/asn1/DERTaggedObject;
+
+    new-instance v12, Lcom/android/internal/org/bouncycastle/asn1/DERSequence;
+
+    const/4 v13, 0x4
+
+    new-array v13, v13, [Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;
+
+    new-instance v14, Lcom/android/internal/org/bouncycastle/asn1/DEROctetString;
+
+    invoke-direct {v14, v0}, Lcom/android/internal/org/bouncycastle/asn1/DEROctetString;-><init>([B)V
+
+    aput-object v14, v13, v8
+
+    sget-object v0, Lcom/android/internal/org/bouncycastle/asn1/ASN1Boolean;->TRUE:Lcom/android/internal/org/bouncycastle/asn1/ASN1Boolean;
+
+    const/4 v14, 0x1
+
+    aput-object v0, v13, v14
+
+    new-instance v0, Lcom/android/internal/org/bouncycastle/asn1/ASN1Enumerated;
+
+    invoke-direct {v0, v8}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Enumerated;-><init>(I)V
+
+    const/16 v20, 0x2
+
+    aput-object v0, v13, v20
+
+    new-instance v0, Lcom/android/internal/org/bouncycastle/asn1/DEROctetString;
+
+    invoke-direct {v0, v9}, Lcom/android/internal/org/bouncycastle/asn1/DEROctetString;-><init>([B)V
+
+    aput-object v0, v13, v10
+
+    invoke-direct {v12, v13}, Lcom/android/internal/org/bouncycastle/asn1/DERSequence;-><init>([Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    invoke-direct {v11, v15, v12}, Lcom/android/internal/org/bouncycastle/asn1/DERTaggedObject;-><init>(ILcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    new-instance v0, Lcom/android/internal/org/bouncycastle/asn1/DERTaggedObject;
+
+    new-instance v9, Lcom/android/internal/org/bouncycastle/asn1/ASN1Integer;
+
+    const-wide/32 v12, 0x222e0
+
+    invoke-direct {v9, v12, v13}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Integer;-><init>(J)V
+
+    const/16 v10, 0x2c1
+
+    invoke-direct {v0, v10, v9}, Lcom/android/internal/org/bouncycastle/asn1/DERTaggedObject;-><init>(ILcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    new-instance v9, Lcom/android/internal/org/bouncycastle/asn1/DERTaggedObject;
+
+    new-instance v10, Lcom/android/internal/org/bouncycastle/asn1/ASN1Integer;
+
+    invoke-static {v8}, Lio/mesalabs/unica/KeyStoreHooks;->getSecurityPatchLevel(Z)I
+
+    move-result v12
+
+    int-to-long v12, v12
+
+    invoke-direct {v10, v12, v13}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Integer;-><init>(J)V
+
+    const/16 v12, 0x2c2
+
+    invoke-direct {v9, v12, v10}, Lcom/android/internal/org/bouncycastle/asn1/DERTaggedObject;-><init>(ILcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    new-instance v10, Lcom/android/internal/org/bouncycastle/asn1/DERTaggedObject;
+
+    new-instance v12, Lcom/android/internal/org/bouncycastle/asn1/ASN1Integer;
+
+    invoke-static {v14}, Lio/mesalabs/unica/KeyStoreHooks;->getSecurityPatchLevel(Z)I
+
+    move-result v13
+
+    move-object/from16 v16, v9
+
+    int-to-long v8, v13
+
+    invoke-direct {v12, v8, v9}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Integer;-><init>(J)V
+
+    const/16 v8, 0x2cf
+
+    invoke-direct {v10, v8, v12}, Lcom/android/internal/org/bouncycastle/asn1/DERTaggedObject;-><init>(ILcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    new-instance v8, Lcom/android/internal/org/bouncycastle/asn1/DERTaggedObject;
+
+    new-instance v9, Lcom/android/internal/org/bouncycastle/asn1/ASN1Integer;
+
+    invoke-static {v14}, Lio/mesalabs/unica/KeyStoreHooks;->getSecurityPatchLevel(Z)I
+
+    move-result v12
+
+    int-to-long v12, v12
+
+    invoke-direct {v9, v12, v13}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Integer;-><init>(J)V
+
+    const/16 v12, 0x2ce
+
+    invoke-direct {v8, v12, v9}, Lcom/android/internal/org/bouncycastle/asn1/DERTaggedObject;-><init>(ILcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    invoke-virtual {v5, v11}, Lcom/android/internal/org/bouncycastle/asn1/ASN1EncodableVector;->add(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    invoke-virtual {v5, v0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1EncodableVector;->add(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    move-object/from16 v0, v16
+
+    invoke-virtual {v5, v0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1EncodableVector;->add(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    invoke-virtual {v5, v10}, Lcom/android/internal/org/bouncycastle/asn1/ASN1EncodableVector;->add(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    invoke-virtual {v5, v8}, Lcom/android/internal/org/bouncycastle/asn1/ASN1EncodableVector;->add(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    new-instance v0, Lcom/android/internal/org/bouncycastle/asn1/DERSequence;
+
+    invoke-direct {v0, v5}, Lcom/android/internal/org/bouncycastle/asn1/DERSequence;-><init>(Lcom/android/internal/org/bouncycastle/asn1/ASN1EncodableVector;)V
+
+    const/4 v5, 0x7
+
+    aput-object v0, v3, v5
+
+    new-instance v0, Lcom/android/internal/org/bouncycastle/asn1/x509/Extension;
+
+    sget-object v5, Lio/mesalabs/unica/KeyStoreHooks;->ASN1_OID:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    new-instance v8, Lcom/android/internal/org/bouncycastle/asn1/DEROctetString;
+
+    new-instance v9, Lcom/android/internal/org/bouncycastle/asn1/DERSequence;
+
+    invoke-direct {v9, v3}, Lcom/android/internal/org/bouncycastle/asn1/DERSequence;-><init>([Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    invoke-direct {v8, v9}, Lcom/android/internal/org/bouncycastle/asn1/DEROctetString;-><init>(Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    const/4 v3, 0x0
+
+    invoke-direct {v0, v5, v3, v8}, Lcom/android/internal/org/bouncycastle/asn1/x509/Extension;-><init>(Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;ZLcom/android/internal/org/bouncycastle/asn1/ASN1OctetString;)V
+
+    invoke-virtual {v7, v0}, Lcom/android/internal/org/bouncycastle/cert/X509v3CertificateBuilder;->addExtension(Lcom/android/internal/org/bouncycastle/asn1/x509/Extension;)Lcom/android/internal/org/bouncycastle/cert/X509v3CertificateBuilder;
+
+    invoke-virtual {v4}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getExtensions()Lcom/android/internal/org/bouncycastle/asn1/x509/Extensions;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Lcom/android/internal/org/bouncycastle/asn1/x509/Extensions;->getExtensionOIDs()[Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    move-result-object v0
+
+    array-length v5, v0
+
+    move v8, v3
+
+    :goto_6
+    if-ge v8, v5, :cond_e
+
+    aget-object v3, v0, v8
+
+    sget-object v9, Lio/mesalabs/unica/KeyStoreHooks;->ASN1_OID:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    invoke-virtual {v9}, Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;->getId()Ljava/lang/String;
+
+    move-result-object v9
+
+    invoke-virtual {v3}, Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;->getId()Ljava/lang/String;
+
+    move-result-object v10
+
+    invoke-virtual {v9, v10}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v9
+
+    if-eqz v9, :cond_d
+
+    goto :goto_7
+
+    :cond_d
+    invoke-virtual {v4, v3}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getExtension(Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;)Lcom/android/internal/org/bouncycastle/asn1/x509/Extension;
+
+    move-result-object v3
+
+    invoke-virtual {v7, v3}, Lcom/android/internal/org/bouncycastle/cert/X509v3CertificateBuilder;->addExtension(Lcom/android/internal/org/bouncycastle/asn1/x509/Extension;)Lcom/android/internal/org/bouncycastle/cert/X509v3CertificateBuilder;
+
+    :goto_7
+    add-int/lit8 v8, v8, 0x1
+
+    goto :goto_6
+
+    :cond_e
+    invoke-virtual {v7, v6}, Lcom/android/internal/org/bouncycastle/cert/X509v3CertificateBuilder;->build(Lcom/android/internal/org/bouncycastle/operator/ContentSigner;)Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Lcom/android/internal/org/bouncycastle/cert/X509CertificateHolder;->getEncoded()[B
+
+    move-result-object v0
+
+    sget-object v3, Lio/mesalabs/unica/KeyStoreHooks;->sHackedCerts:Ljava/util/Map;
+
+    invoke-interface {v3, v2, v0}, Ljava/util/Map;->put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
+
+    return-object v0
+
+    :cond_f
+    new-instance v2, Ljava/lang/UnsupportedOperationException;
+
+    new-instance v3, Ljava/lang/StringBuilder;
+
+    invoke-direct {v3}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v4, "unsupported algorithm "
+
+    invoke-virtual {v3, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v3
+
+    invoke-virtual {v0}, Ljava/security/cert/X509Certificate;->getPublicKey()Ljava/security/PublicKey;
+
+    move-result-object v0
+
+    invoke-interface {v0}, Ljava/security/PublicKey;->getAlgorithm()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-virtual {v3, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-direct {v2, v0}, Ljava/lang/UnsupportedOperationException;-><init>(Ljava/lang/String;)V
+
+    throw v2
+
+    :cond_10
+    :goto_8
+    const-string v0, "Not a GAK key"
+
+    invoke-static {v0}, Lio/mesalabs/unica/KeyStoreHooks;->dlog(Ljava/lang/String;)V
+    :try_end_5
+    .catch Ljava/lang/Exception; {:try_start_5 .. :try_end_5} :catch_3
+
+    return-object v1
+
+    :catch_3
+    move-exception v0
+
+    invoke-virtual {v0}, Ljava/lang/Exception;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lio/mesalabs/unica/KeyStoreHooks;->dlog(Ljava/lang/String;)V
+
+    :cond_11
+    :goto_9
+    return-object v1
+.end method
+
+.method private static blacklist isAllZeros([B)Z
+    .locals 4
+
+    array-length v0, p0
+
+    const/4 v1, 0x0
+
+    move v2, v1
+
+    :goto_0
+    if-ge v2, v0, :cond_1
+
+    aget-byte v3, p0, v2
+
+    if-eqz v3, :cond_0
+
+    return v1
+
+    :cond_0
+    add-int/lit8 v2, v2, 0x1
+
+    goto :goto_0
+
+    :cond_1
+    const/4 p0, 0x1
+
+    return p0
+.end method
+
+.method private static blacklist isPIFEnabled()Z
+    .locals 4
+
+    const-string v0, "persist.sys.unica.pif"
+
+    const/4 v1, 0x1
+
+    invoke-static {v0, v1}, Landroid/os/SemSystemProperties;->getBoolean(Ljava/lang/String;Z)Z
+
+    move-result v0
+
+    const/4 v2, 0x0
+
+    if-nez v0, :cond_0
+
+    return v2
+
+    :cond_0
+    invoke-static {}, Landroid/app/Application;->getProcessName()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Landroid/text/TextUtils;->isEmpty(Ljava/lang/CharSequence;)Z
+
+    move-result v3
+
+    if-nez v3, :cond_2
+
+    const-string v3, "com.google.android.gms"
+
+    invoke-virtual {v0, v3}, Ljava/lang/String;->startsWith(Ljava/lang/String;)Z
+
+    move-result v3
+
+    if-nez v3, :cond_1
+
+    const-string v3, "com.android.vending"
+
+    invoke-virtual {v0, v3}, Ljava/lang/String;->startsWith(Ljava/lang/String;)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_2
+
+    :cond_1
+    return v2
+
+    :cond_2
+    return v1
+.end method
+
+.method public static blacklist onHasSystemFeatureHook(Ljava/lang/String;)Ljava/lang/Boolean;
+    .locals 3
+
+    invoke-static {}, Lio/mesalabs/unica/KeyStoreHooks;->isPIFEnabled()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    const-string v0, "android.hardware.keystore.app_attest_key"
+
+    invoke-virtual {v0, p0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    const-string v0, "android.hardware.strongbox_keystore"
+
+    invoke-virtual {v0, p0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    :cond_0
+    sget-object v0, Ljava/lang/Boolean;->FALSE:Ljava/lang/Boolean;
+
+    goto :goto_0
+
+    :cond_1
+    const/4 v0, 0x0
+
+    :goto_0
+    if-eqz v0, :cond_2
+
+    new-instance v1, Ljava/lang/StringBuilder;
+
+    const-string v2, "Spoofing \""
+
+    invoke-direct {v1, v2}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
+
+    invoke-virtual {v1, p0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object p0
+
+    const-string v1, "\" feature to \""
+
+    invoke-virtual {p0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object p0
+
+    invoke-virtual {p0, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
+
+    move-result-object p0
+
+    const-string v1, "\""
+
+    invoke-virtual {p0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-static {p0}, Lio/mesalabs/unica/KeyStoreHooks;->dlog(Ljava/lang/String;)V
+
+    :cond_2
+    return-object v0
+.end method
+
+.method private static blacklist parseCert(Ljava/lang/String;)Ljava/security/cert/Certificate;
+    .locals 2
+    .annotation system Ldalvik/annotation/Throws;
+        value = {
+            Ljava/lang/Exception;
+        }
+    .end annotation
+
+    new-instance v0, Lcom/android/internal/org/bouncycastle/util/io/pem/PemReader;
+
+    new-instance v1, Ljava/io/StringReader;
+
+    invoke-direct {v1, p0}, Ljava/io/StringReader;-><init>(Ljava/lang/String;)V
+
+    invoke-direct {v0, v1}, Lcom/android/internal/org/bouncycastle/util/io/pem/PemReader;-><init>(Ljava/io/Reader;)V
+
+    sget-object p0, Lio/mesalabs/unica/KeyStoreHooks;->sCertificateFactory:Ljava/security/cert/CertificateFactory;
+
+    new-instance v1, Ljava/io/ByteArrayInputStream;
+
+    invoke-virtual {v0}, Lcom/android/internal/org/bouncycastle/util/io/pem/PemReader;->readPemObject()Lcom/android/internal/org/bouncycastle/util/io/pem/PemObject;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Lcom/android/internal/org/bouncycastle/util/io/pem/PemObject;->getContent()[B
+
+    move-result-object v0
+
+    invoke-direct {v1, v0}, Ljava/io/ByteArrayInputStream;-><init>([B)V
+
+    invoke-virtual {p0, v1}, Ljava/security/cert/CertificateFactory;->generateCertificate(Ljava/io/InputStream;)Ljava/security/cert/Certificate;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method private static blacklist parsePrivateKey(Ljava/lang/String;Z)Ljava/security/PrivateKey;
+    .locals 2
+    .annotation system Ldalvik/annotation/Throws;
+        value = {
+            Ljava/lang/Exception;
+        }
+    .end annotation
+
+    new-instance v0, Lcom/android/internal/org/bouncycastle/util/io/pem/PemReader;
+
+    new-instance v1, Ljava/io/StringReader;
+
+    invoke-direct {v1, p0}, Ljava/io/StringReader;-><init>(Ljava/lang/String;)V
+
+    invoke-direct {v0, v1}, Lcom/android/internal/org/bouncycastle/util/io/pem/PemReader;-><init>(Ljava/io/Reader;)V
+
+    invoke-virtual {v0}, Lcom/android/internal/org/bouncycastle/util/io/pem/PemReader;->readPemObject()Lcom/android/internal/org/bouncycastle/util/io/pem/PemObject;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Lcom/android/internal/org/bouncycastle/util/io/pem/PemObject;->getContent()[B
+
+    move-result-object p0
+
+    invoke-static {p0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->getInstance(Ljava/lang/Object;)Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;
+
+    move-result-object p0
+
+    if-eqz p1, :cond_0
+
+    invoke-static {p0}, Lcom/android/internal/org/bouncycastle/asn1/sec/ECPrivateKey;->getInstance(Ljava/lang/Object;)Lcom/android/internal/org/bouncycastle/asn1/sec/ECPrivateKey;
+
+    move-result-object p0
+
+    new-instance p1, Lcom/android/internal/org/bouncycastle/asn1/x509/AlgorithmIdentifier;
+
+    sget-object v0, Lcom/android/internal/org/bouncycastle/asn1/x9/X9ObjectIdentifiers;->id_ecPublicKey:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    invoke-virtual {p0}, Lcom/android/internal/org/bouncycastle/asn1/sec/ECPrivateKey;->getParameters()Lcom/android/internal/org/bouncycastle/asn1/ASN1Primitive;
+
+    move-result-object v1
+
+    invoke-direct {p1, v0, v1}, Lcom/android/internal/org/bouncycastle/asn1/x509/AlgorithmIdentifier;-><init>(Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    new-instance v0, Lcom/android/internal/org/bouncycastle/asn1/pkcs/PrivateKeyInfo;
+
+    invoke-direct {v0, p1, p0}, Lcom/android/internal/org/bouncycastle/asn1/pkcs/PrivateKeyInfo;-><init>(Lcom/android/internal/org/bouncycastle/asn1/x509/AlgorithmIdentifier;Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    const-string p0, "ECDSA"
+
+    invoke-static {p0}, Lio/mesalabs/unica/KeyStoreHooks;->getKeyFactory(Ljava/lang/String;)Ljava/security/KeyFactory;
+
+    move-result-object p0
+
+    new-instance p1, Ljava/security/spec/PKCS8EncodedKeySpec;
+
+    invoke-virtual {v0}, Lcom/android/internal/org/bouncycastle/asn1/pkcs/PrivateKeyInfo;->getEncoded()[B
+
+    move-result-object v0
+
+    invoke-direct {p1, v0}, Ljava/security/spec/PKCS8EncodedKeySpec;-><init>([B)V
+
+    invoke-virtual {p0, p1}, Ljava/security/KeyFactory;->generatePrivate(Ljava/security/spec/KeySpec;)Ljava/security/PrivateKey;
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
+    invoke-static {p0}, Lcom/android/internal/org/bouncycastle/asn1/pkcs/RSAPrivateKey;->getInstance(Ljava/lang/Object;)Lcom/android/internal/org/bouncycastle/asn1/pkcs/RSAPrivateKey;
+
+    move-result-object p1
+
+    invoke-virtual {p0}, Lcom/android/internal/org/bouncycastle/asn1/ASN1Sequence;->size()I
+
+    move-result p0
+
+    const/16 v0, 0x9
+
+    if-ne p0, v0, :cond_1
+
+    new-instance p0, Lcom/android/internal/org/bouncycastle/asn1/x509/AlgorithmIdentifier;
+
+    sget-object v0, Lcom/android/internal/org/bouncycastle/asn1/pkcs/PKCSObjectIdentifiers;->rsaEncryption:Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;
+
+    sget-object v1, Lcom/android/internal/org/bouncycastle/asn1/DERNull;->INSTANCE:Lcom/android/internal/org/bouncycastle/asn1/DERNull;
+
+    invoke-direct {p0, v0, v1}, Lcom/android/internal/org/bouncycastle/asn1/x509/AlgorithmIdentifier;-><init>(Lcom/android/internal/org/bouncycastle/asn1/ASN1ObjectIdentifier;Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    new-instance v0, Lcom/android/internal/org/bouncycastle/asn1/pkcs/PrivateKeyInfo;
+
+    invoke-direct {v0, p0, p1}, Lcom/android/internal/org/bouncycastle/asn1/pkcs/PrivateKeyInfo;-><init>(Lcom/android/internal/org/bouncycastle/asn1/x509/AlgorithmIdentifier;Lcom/android/internal/org/bouncycastle/asn1/ASN1Encodable;)V
+
+    const-string p0, "RSA"
+
+    invoke-static {p0}, Lio/mesalabs/unica/KeyStoreHooks;->getKeyFactory(Ljava/lang/String;)Ljava/security/KeyFactory;
+
+    move-result-object p0
+
+    new-instance p1, Ljava/security/spec/PKCS8EncodedKeySpec;
+
+    invoke-virtual {v0}, Lcom/android/internal/org/bouncycastle/asn1/pkcs/PrivateKeyInfo;->getEncoded()[B
+
+    move-result-object v0
+
+    invoke-direct {p1, v0}, Ljava/security/spec/PKCS8EncodedKeySpec;-><init>([B)V
+
+    invoke-virtual {p0, p1}, Ljava/security/KeyFactory;->generatePrivate(Ljava/security/spec/KeySpec;)Ljava/security/PrivateKey;
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_1
+    new-instance p0, Ljava/lang/Exception;
+
+    const-string p1, "malformed sequence in RSA private key"
+
+    invoke-direct {p0, p1}, Ljava/lang/Exception;-><init>(Ljava/lang/String;)V
+
+    throw p0
+.end method
+
+.method private static blacklist toPrimitive([Ljava/lang/Byte;)[B
+    .locals 3
+
+    if-nez p0, :cond_0
+
+    const/4 p0, 0x0
+
+    return-object p0
+
+    :cond_0
+    array-length v0, p0
+
+    const/4 v1, 0x0
+
+    if-nez v0, :cond_1
+
+    new-array p0, v1, [B
+
+    return-object p0
+
+    :cond_1
+    array-length v0, p0
+
+    new-array v0, v0, [B
+
+    :goto_0
+    array-length v2, p0
+
+    if-ge v1, v2, :cond_2
+
+    aget-object v2, p0, v1
+
+    invoke-virtual {v2}, Ljava/lang/Byte;->byteValue()B
+
+    move-result v2
+
+    aput-byte v2, v0, v1
+
+    add-int/lit8 v1, v1, 0x1
+
+    goto :goto_0
+
+    :cond_2
+    return-object v0
+.end method
-- 
2.48.1

