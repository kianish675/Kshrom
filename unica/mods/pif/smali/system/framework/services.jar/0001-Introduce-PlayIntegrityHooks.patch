From 29ff9e0de8fe5a848920c79c551c664070b645da Mon Sep 17 00:00:00 2001
From: BlackMesa123 <giangrecosalvo9@gmail.com>
Date: Mon Apr 28 11:01:50 2025 +0300
Subject: [PATCH] Introduce PlayIntegrityHooks

---
 .../wm/ActivityTaskManagerService.smali       | 22 +++++++++++++++++--
 1 file changed, 20 insertions(+), 2 deletions(-)

diff --git a/smali_classes2/com/android/server/wm/ActivityTaskManagerService.smali b/smali_classes2/com/android/server/wm/ActivityTaskManagerService.smali
index 05933ea..08994f2 100644
--- a/smali_classes2/com/android/server/wm/ActivityTaskManagerService.smali
+++ b/smali_classes2/com/android/server/wm/ActivityTaskManagerService.smali
@@ -6669,10 +6669,19 @@
 .method public final getFocusedRootTaskInfo()Landroid/app/ActivityTaskManager$RootTaskInfo;
     .locals 5
 
+    iget-object v5, p0, Lcom/android/server/wm/ActivityTaskManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v5}, Lio/mesalabs/unica/PlayIntegrityHooks;->shouldBypassTaskPermission(Landroid/content/Context;)Z
+
+    move-result v5
+
+    if-nez v5, :cond_2
+
     const-string v0, "getFocusedRootTaskInfo()"
 
     invoke-static {v0}, Lcom/android/server/wm/ActivityTaskManagerService;->enforceTaskPermission(Ljava/lang/String;)V
 
+    :cond_2
     invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
 
     move-result-wide v0
@@ -12087,10 +12096,19 @@
 .method public final registerTaskStackListener(Landroid/app/ITaskStackListener;)V
     .locals 2
 
+    iget-object v2, p0, Lcom/android/server/wm/ActivityTaskManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v2}, Lio/mesalabs/unica/PlayIntegrityHooks;->shouldBypassTaskPermission(Landroid/content/Context;)Z
+
+    move-result v2
+
+    if-nez v2, :cond_4
+
     const-string/jumbo v0, "registerTaskStackListener()"
 
     invoke-static {v0}, Lcom/android/server/wm/ActivityTaskManagerService;->enforceTaskPermission(Ljava/lang/String;)V
 
+    :cond_4
     iget-object p0, p0, Lcom/android/server/wm/ActivityTaskManagerService;->mTaskChangeNotificationController:Lcom/android/server/wm/TaskChangeNotificationController;
 
     invoke-virtual {p0}, Ljava/lang/Object;->getClass()Ljava/lang/Class;

-- 
2.46.0

